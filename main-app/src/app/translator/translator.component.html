<div class="fill-height px-2 pb-2 d-flex justify-content-center px-lg-5">
  <section class="w-100 d-flex flex-column">
    
    <!-- Language Selectors -->
    <div class="w-100 px-2 pb-3 px-lg-3" *ngIf="!hasStartedListening">
      <div class="row g-3">
        <!-- Speaker A Language -->
        <div class="col-12 col-md-6">
          <h4 class="mb-3 fw-bold">{{ 'translator.speaker-a' | translate }}</h4>
          <div class="row g-3">
            <!-- Source Language A -->
            <div class="col-6">
              <div class="position-relative">
                <label class="mb-2 d-block small fw-bold">{{ 'translator.source-language' | translate }}</label>
                <button 
                  mat-stroked-button 
                  (click)="showLanguageSelectorA = !showLanguageSelectorA"
                  class="w-100 d-flex justify-content-between align-items-center"
                  [class.speaker-a]="true">
                  <span>
                    {{ getSelectedLanguageNameA() }}
                  </span>
                  <mat-icon>{{ showLanguageSelectorA ? 'expand_less' : 'expand_more' }}</mat-icon>
                </button>

                <!-- Language Dropdown A -->
                <div 
                  *ngIf="showLanguageSelectorA" 
                  class="language-selector-dropdown"
                  [class.rtl]="isRTL">
                  <div class="p-2">
                    <mat-form-field class="w-100">
                      <mat-label>{{ 'translator.search-language' | translate }}</mat-label>
                      <input 
                        matInput 
                        [(ngModel)]="languageSearchTermA"
                        (input)="filterLanguagesA()"
                        [placeholder]="'translator.search-language-placeholder' | translate">
                      <mat-icon matPrefix>search</mat-icon>
                    </mat-form-field>
                  </div>
                  <div class="language-list">
                    <div 
                      *ngFor="let lang of filteredLanguagesA"
                      [class.selected]="selectedLanguageA === lang.code"
                      (click)="onLanguageChangeA(lang.code)"
                      class="language-item">
                      <div class="d-flex flex-column">
                        <span class="fw-bold">{{ lang.nativeName }}</span>
                        <span class="text-muted small">{{ lang.name }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Translation Language Selector A -->
            <div class="col-6">
              <div class="position-relative">
                <label class="mb-2 d-block small fw-bold">{{ 'translator.translation-language' | translate }}</label>
                <button 
                  mat-stroked-button 
                  (click)="showTranslationLanguageSelectorA = !showTranslationLanguageSelectorA"
                  class="w-100 d-flex justify-content-between align-items-center">
                  <span>
                    {{ getSelectedTranslationLanguageNameA() }}
                  </span>
                  <mat-icon>{{ showTranslationLanguageSelectorA ? 'expand_less' : 'expand_more' }}</mat-icon>
                </button>

                <!-- Translation Language Dropdown A -->
                <div 
                  *ngIf="showTranslationLanguageSelectorA" 
                  class="language-selector-dropdown"
                  [class.rtl]="isRTL">
                  <div class="p-2">
                    <mat-form-field class="w-100">
                      <mat-label>{{ 'translator.search-language' | translate }}</mat-label>
                      <input 
                        matInput 
                        [(ngModel)]="translationLanguageSearchTermA"
                        (input)="filterTranslationLanguagesA()"
                        [placeholder]="'translator.search-language-placeholder' | translate">
                      <mat-icon matPrefix>search</mat-icon>
                    </mat-form-field>
                  </div>
                  <div class="language-list">
                    <div 
                      *ngFor="let lang of filteredTranslationLanguagesA"
                      [class.selected]="selectedTranslationLanguageA === lang.code"
                      (click)="onTranslationLanguageChangeA(lang.code)"
                      class="language-item">
                      <div class="d-flex flex-column">
                        <span class="fw-bold">{{ lang.nativeName }}</span>
                        <span class="text-muted small">{{ lang.name }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Speaker B Language -->
        <div class="col-12 col-md-6">
          <h4 class="mb-3 fw-bold">{{ 'translator.speaker-b' | translate }}</h4>
          <div class="row g-3">
            <!-- Source Language B -->
            <div class="col-6">
              <div class="position-relative">
                <label class="mb-2 d-block small fw-bold">{{ 'translator.source-language' | translate }}</label>
                <button 
                  mat-stroked-button 
                  (click)="showLanguageSelectorB = !showLanguageSelectorB"
                  class="w-100 d-flex justify-content-between align-items-center"
                  [class.speaker-b]="true">
                  <span>
                    {{ getSelectedLanguageNameB() }}
                  </span>
                  <mat-icon>{{ showLanguageSelectorB ? 'expand_less' : 'expand_more' }}</mat-icon>
                </button>

                <!-- Language Dropdown B -->
                <div 
                  *ngIf="showLanguageSelectorB" 
                  class="language-selector-dropdown"
                  [class.rtl]="isRTL">
                  <div class="p-2">
                    <mat-form-field class="w-100">
                      <mat-label>{{ 'translator.search-language' | translate }}</mat-label>
                      <input 
                        matInput 
                        [(ngModel)]="languageSearchTermB"
                        (input)="filterLanguagesB()"
                        [placeholder]="'translator.search-language-placeholder' | translate">
                      <mat-icon matPrefix>search</mat-icon>
                    </mat-form-field>
                  </div>
                  <div class="language-list">
                    <div 
                      *ngFor="let lang of filteredLanguagesB"
                      [class.selected]="selectedLanguageB === lang.code"
                      (click)="onLanguageChangeB(lang.code)"
                      class="language-item">
                      <div class="d-flex flex-column">
                        <span class="fw-bold">{{ lang.nativeName }}</span>
                        <span class="text-muted small">{{ lang.name }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Translation Language Selector B -->
            <div class="col-6">
              <div class="position-relative">
                <label class="mb-2 d-block small fw-bold">{{ 'translator.translation-language' | translate }}</label>
                <button 
                  mat-stroked-button 
                  (click)="showTranslationLanguageSelectorB = !showTranslationLanguageSelectorB"
                  class="w-100 d-flex justify-content-between align-items-center">
                  <span>
                    {{ getSelectedTranslationLanguageNameB() }}
                  </span>
                  <mat-icon>{{ showTranslationLanguageSelectorB ? 'expand_less' : 'expand_more' }}</mat-icon>
                </button>

                <!-- Translation Language Dropdown B -->
                <div 
                  *ngIf="showTranslationLanguageSelectorB" 
                  class="language-selector-dropdown"
                  [class.rtl]="isRTL">
                  <div class="p-2">
                    <mat-form-field class="w-100">
                      <mat-label>{{ 'translator.search-language' | translate }}</mat-label>
                      <input 
                        matInput 
                        [(ngModel)]="translationLanguageSearchTermB"
                        (input)="filterTranslationLanguagesB()"
                        [placeholder]="'translator.search-language-placeholder' | translate">
                      <mat-icon matPrefix>search</mat-icon>
                    </mat-form-field>
                  </div>
                  <div class="language-list">
                    <div 
                      *ngFor="let lang of filteredTranslationLanguagesB"
                      [class.selected]="selectedTranslationLanguageB === lang.code"
                      (click)="onTranslationLanguageChangeB(lang.code)"
                      class="language-item">
                      <div class="d-flex flex-column">
                        <span class="fw-bold">{{ lang.nativeName }}</span>
                        <span class="text-muted small">{{ lang.name }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Error Message -->
    <div *ngIf="errorMessage" class="w-100 px-2 pb-3 px-lg-3">
      <mat-card class="error-card">
        <mat-card-content>
          <div class="d-flex align-items-center">
            <mat-icon color="warn" class="me-2">error</mat-icon>
            <span>{{ errorMessage }}</span>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Live History -->
      <div class="w-100" *ngIf="isListening || transcriptHistory.length > 0">
        <!-- Speaker Toggle (visible while listening) -->
        <div class="speaker-toggle-container mb-3" *ngIf="isListening">
          <mat-button-toggle-group
            [value]="currentSpeaker"
            (change)="onSpeakerToggle($event.value)"
            name="speakerToggle"
            class="speaker-toggle-group"
            [multiple]="false">
            <mat-button-toggle value="A" class="speaker-toggle-btn speaker-a-btn">
              {{ getSpeakerName('A') }}
            </mat-button-toggle>
            <mat-button-toggle value="B" class="speaker-toggle-btn speaker-b-btn">
              {{ getSpeakerName('B') }}
            </mat-button-toggle>
          </mat-button-toggle-group>
        </div>

        <!-- Menu Button (fixed top-left) - visible when listening has started -->
        <button
          *ngIf="hasStartedListening"
          mat-mini-fab
          class="menu-btn"
          [matMenuTriggerFor]="historyMenu"
          [matTooltip]="'translator.menu' | translate">
          <mat-icon>more_vert</mat-icon>
        </button>
        <mat-menu #historyMenu="matMenu">
          <button mat-menu-item (click)="resetToInitialState()">
            <mat-icon>close</mat-icon>
            <span>{{ 'translator.exit' | translate }}</span>
          </button>
          <button mat-menu-item (click)="clearTranscript()" [disabled]="transcriptHistory.length === 0">
            <mat-icon>delete</mat-icon>
            <span>{{ 'translator.clear-history' | translate }}</span>
          </button>
          <button mat-menu-item (click)="copyHistoryToClipboard()" [disabled]="transcriptHistory.length === 0">
            <mat-icon>content_copy</mat-icon>
            <span>{{ 'translator.copy-history' | translate }}</span>
          </button>
        </mat-menu>
        
        <!-- Full History -->
        <mat-card>
          <mat-card-content>
            <div class="history-list play-style" [class.empty]="transcriptHistory.length === 0">
              <div 
                *ngFor="let item of reversedTranscriptHistory; let first = first"
                class="history-item play-item"
                [class.speaker-a-item]="item.speaker === 'A'"
                [class.speaker-b-item]="item.speaker === 'B'"
                [class.live]="first && status === 'listening'"
                [dir]="isRTL ? 'rtl' : 'ltr'">
                <div class="speaker-text">
                  <span *ngIf="item.isWaiting" class="waiting-spinner">
                    <mat-spinner diameter="16" class="inline-spinner"></mat-spinner>
                  </span>
                  <span *ngIf="!item.isWaiting">{{ item.text }}</span>
                  <span *ngIf="first && status === 'listening' && !item.isWaiting" class="live-cursor">|</span>
                </div>
              </div>
              <div *ngIf="transcriptHistory.length === 0" class="empty-state">
                <p class="text-muted text-center">
                  {{ 'translator.transcript-placeholder' | translate }}
                </p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

  </section>
  
  <!-- Floating Microphone Container -->
  <div class="floating-microphone-container" [class.listening]="hasStartedListening" [dir]="isRTL ? 'rtl' : 'ltr'">
    <div class="floating-microphone-content">
      <!-- Microphone Button -->
      <button 
        mat-fab 
        [color]="getStatusColor()"
        [class.listening]="isListening && !isPaused"
        (click)="toggleListening()"
        [disabled]="status === 'error'"
        class="microphone-button">
        <mat-icon>{{ getStatusIcon() }}</mat-icon>
      </button>
    </div>
  </div>
</div>

