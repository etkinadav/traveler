<div class="threejs-box-wrapper">
    <!-- הודעת validation הוסרה - משתמשים ב-SnackBar -->
    
    <!-- קונטיינר לכפתורי תצוגה -->
    <div class="view-controls-container">
        <!-- כפתור להצגת wireframe - מוסתר במובייל -->
        <button class="wireframe-toggle hide-on-mobile" (click)="toggleWireframe()" 
                [class.active]="showWireframe" 
                matTooltip="הצג את מידות המוצר המלאות"
                matTooltipPosition="below">
            <!-- SVG Icon -->
            <svg width="12" height="12" viewBox="0 0 12 12" style="margin-left:8px;">
                <rect x="1" y="1" width="10" height="10" stroke="currentColor" stroke-width="0.8" fill="none"/>
                <line x1="1" y1="6" x2="11" y2="6" stroke="currentColor" stroke-width="0.8"/>
                <line x1="6" y1="1" x2="6" y2="11" stroke="currentColor" stroke-width="0.8"/>
            </svg>
            <span class="button-text">{{ showWireframe ? ('hide_dimensions' | translate) : ('show_dimensions' | translate) }}</span>
        </button>
        
        <!-- כפתור תפריט אפשרויות נוספות -->
        <button class="options-menu-button" 
                [class.active]="isOptionsMenuOpen"
                [matMenuTriggerFor]="optionsMenu"
                #menuTrigger="matMenuTrigger"
                (menuOpened)="isOptionsMenuOpen = true"
                (menuClosed)="isOptionsMenuOpen = false"
                matTooltip="אפשרויות נוספות"
                matTooltipPosition="below">
            <svg width="12" height="12" viewBox="0 0 12 12">
                <circle cx="6" cy="2" r="1.2" fill="currentColor"/>
                <circle cx="6" cy="6" r="1.2" fill="currentColor"/>
                <circle cx="6" cy="10" r="1.2" fill="currentColor"/>
            </svg>
        </button>
    </div>
    
    <!-- תפריט אפשרויות נוספות -->
    <mat-menu #optionsMenu="matMenu" xPosition="after" class="custom-options-menu">
        <!-- אפשרות הצג מידות - מוצג רק במובייל -->
        <button mat-menu-item (click)="toggleWireframe()" [class.active]="showWireframe" class="menu-option show-on-mobile">
            <svg width="12" height="12" viewBox="0 0 12 12" class="menu-icon">
                <rect x="1" y="1" width="10" height="10" stroke="currentColor" stroke-width="0.8" fill="none"/>
                <line x1="1" y1="6" x2="11" y2="6" stroke="currentColor" stroke-width="0.8"/>
                <line x1="6" y1="1" x2="6" y2="11" stroke="currentColor" stroke-width="0.8"/>
            </svg>
            <span class="menu-text">{{ showWireframe ? 'הסתר מידות' : 'הצג מידות' }}</span>
        </button>
        
        <!-- אפשרות מצב שקוף -->
        <button mat-menu-item (click)="toggleTransparentMode()" [class.active]="isTransparentMode" class="menu-option">
            <svg width="14" height="14" viewBox="0 0 14 14" class="menu-icon">
                <!-- ריבוע חיצוני שקוף -->
                <rect x="1.5" y="1.5" width="11" height="11" stroke="currentColor" stroke-width="1" fill="none" opacity="0.6"/>
                <!-- ריבוע פנימי שקוף יותר -->
                <rect x="4" y="4" width="6" height="6" stroke="currentColor" stroke-width="0.8" fill="currentColor" opacity="0.25"/>
                <!-- קווים אלכסוניים להדגשת שקיפות -->
                <line x1="2" y1="2" x2="12" y2="12" stroke="currentColor" stroke-width="0.6" opacity="0.4"/>
            </svg>
            <span class="menu-text">מצב שקוף</span>
        </button>
    </mat-menu>
    
    <!-- התרעה על קורות מוסתרות -->
    <div class="hidden-beams-warning" *ngIf="hasHiddenBeams && !hasNoMiddleBeams">
        <svg width="12" height="12" viewBox="0 0 12 12" style="margin-left:8px;">
            <circle cx="6" cy="6" r="5" stroke="currentColor" stroke-width="0.8" fill="none"/>
            <path d="M6 3v3M6 8h.01" stroke="currentColor" stroke-width="0.8" fill="none"/>
        </svg>
        <span class="button-text">{{ 'hidden_beams_warning' | translate }}</span>
    </div>
    
    <!-- התרעה על מקרה קיצון - אין קורות באמצע -->
    <div class="hidden-beams-warning critical" *ngIf="hasNoMiddleBeams">
        <svg width="12" height="12" viewBox="0 0 12 12" style="margin-left:8px;">
            <circle cx="6" cy="6" r="5" stroke="currentColor" stroke-width="0.8" fill="none"/>
            <path d="M6 3v3M6 8h.01" stroke="currentColor" stroke-width="0.8" fill="none"/>
        </svg>
        <span class="button-text">{{ 'no_middle_beams_warning' | translate }}</span>
    </div>
    
    <div class="main-flex-row">
        <div class="controls" [class.closed]="!drawerOpen">
            <button class="drawer-toggle" (click)="toggleDrawer()">
                <svg width="12" height="12" viewBox="0 0 12 12" style="display:block;margin:auto;">
                    <polyline points="4,2 8,6 4,10" stroke="#666" stroke-width="2" fill="none"
                        [attr.transform]="drawerOpen ? 'rotate(180 6 6)' : ''" />
                </svg>
            </button>
            <ng-container *ngIf="drawerOpen">
                <!-- Spinner Loading - מוצג רק בטעינה הראשונית -->
                <div class="loading-spinner" *ngIf="isLoading && isModelLoading">
                    <div class="spinner"></div>
                </div>
                
                <!-- כל התוכן הרגיל - מוצג תמיד -->
                <div>
                <!-- כותרת מוצר -->
                <div class="product-header" *ngIf="selectedProductName" style="margin-bottom: 20px;">
                    <h3 style="margin: 0; padding: 10px; text-align: center;">
                        {{product?.translatedName || selectedProductName}}<br>
                            <span style="margin-top: 8px; font-weight: normal; font-size: 0.8em; display: block;">דגם: {{product?.model || product?.name || selectedProductName}}</span>
                    </h3>
                </div>
                
                <div *ngFor="let param of params" class="param-box">
                    
                    <!-- טיפול בשולחן - פרמטר height -->
                    <div *ngIf="isTable && param.name === 'height'">
                        <label style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <mat-form-field appearance="outline">
                            <mat-label>{{param.translatedName}}</mat-label>
                            <input matInput type="number" [(ngModel)]="param.default" 
                                   [min]="param.min" [max]="param.max" 
                        (blur)="updateModel()"
                        (keyup.enter)="updateModel()"
                        (input)="onNumberInputChange($event, 'updateModel')">
                        </mat-form-field>
                    </div>
                    
                    <!-- טיפול בארון - פרמטר shelfs -->
                    <div *ngIf="!isTable && param.name === 'shelfs'">
                        <label
                            style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <div class="shelf-row">
                            <mat-form-field appearance="outline">
                                <mat-label>סוג קורה</mat-label>
                                <mat-select [(ngModel)]="param.selectedBeamIndex" (selectionChange)="updateBeams()">
                                    <mat-option *ngFor="let beam of param.beams; let bIdx = index" [value]="bIdx">
                                        {{beam.translatedName}}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline">
                                <mat-label>סוג עץ</mat-label>
                                <mat-select [(ngModel)]="param.selectedTypeIndex" (selectionChange)="updateBeams()">
                                    <mat-option
                                        *ngFor="let type of param.beams[param.selectedBeamIndex]?.types; let tIdx = index"
                                        [value]="tIdx">
                                        {{type.translatedName}}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="add-shelf-btn-container">
                            <button class="add-shelf-btn" (click)="param.default.push(param.min); updateBeams()">
                                <svg viewBox="0 0 16 16" width="14" height="14">
                                    <circle cx="8" cy="8" r="7" fill="#fff" />
                                    <line x1="8" y1="4" x2="8" y2="12" stroke="#333" stroke-width="2" />
                                    <line x1="4" y1="8" x2="12" y2="8" stroke="#333" stroke-width="2" />
                                </svg>
                            </button>
                        </div>
                        <div class="shelf-measurements-container beam-array-container">
                            <div *ngFor="let i of [].constructor(param.default.length); let idx = index" class="shelf-row">
                                <div class="shelf-gap-field-wrapper">
                                    <mat-form-field appearance="outline" class="shelf-gap-field">
                                        <mat-label>מידה {{param.default.length - idx}} - {{getUnitForParameter(param)}}</mat-label>
                                        <input matInput type="number" [min]="param.min" [max]="param.max" [step]="1"
                                            [(ngModel)]="param.default[param.default.length - 1 - idx]"
                                            (blur)="updateShelfParameterValue(param, param.default[param.default.length - 1 - idx], param.default.length - 1 - idx)"
                  (keyup.enter)="updateShelfParameterValue(param, param.default[param.default.length - 1 - idx], param.default.length - 1 - idx)"
                  (input)="onShelfInputChange($event, param, idx)">
                                    </mat-form-field>
                                    <button *ngIf="idx !== param.default.length - 1" class="remove-shelf-btn"
                                        (click)="param.default.splice(param.default.length - 1 - idx,1); updateBeams()"
                                        [disabled]="param.default.length<=1" aria-label="הסר מדף">
                                        <svg width="14" height="14" viewBox="0 0 14 14">
                                            <circle cx="7" cy="7" r="6" fill="#fff" stroke="#d32f2f" stroke-width="1.2" />
                                            <line x1="4.5" y1="4.5" x2="9.5" y2="9.5" stroke="#d32f2f" stroke-width="1.5" />
                                            <line x1="9.5" y1="4.5" x2="4.5" y2="9.5" stroke="#d32f2f" stroke-width="1.5" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
            
                        </div>
                    </div>
                    
                    <!-- טיפול בשולחן - פרמטר plata -->
                    <div *ngIf="isTable && param.name === 'plata'">
                        <label style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <div class="shelf-row">
                            <mat-form-field appearance="outline">
                                <mat-label>סוג קורה</mat-label>
                                <mat-select [(ngModel)]="param.selectedBeamIndex" (selectionChange)="updateBeams()">
                                    <mat-option *ngFor="let beam of param.beams; let bIdx = index" [value]="bIdx">
                                        {{beam.translatedName}}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline">
                                <mat-label>סוג עץ</mat-label>
                                <mat-select [(ngModel)]="param.selectedTypeIndex" (selectionChange)="updateBeams()">
                                    <mat-option *ngFor="let type of param.beams[param.selectedBeamIndex || 0]?.types || []; let tIdx = index" [value]="tIdx">
                                        {{type.translatedName}}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                    </div>
                    
                    <div *ngIf="param.type === 'beamSingle' && (!isTable || param.name !== 'plata')">
                        <label
                            style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <mat-form-field appearance="outline">
                            <mat-label>סוג קורה</mat-label>
                            <mat-select [(ngModel)]="param.selectedBeamIndex" (selectionChange)="updateBeams()">
                                <mat-option *ngFor="let beam of param.beams; let bIdx = index" [value]="bIdx">
                                    {{beam.translatedName}}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                        <mat-form-field appearance="outline">
                            <mat-label>סוג עץ</mat-label>
                            <mat-select [(ngModel)]="param.selectedTypeIndex" (selectionChange)="updateBeams()">
                                <mat-option
                                    *ngFor="let type of param.beams[param.selectedBeamIndex]?.types; let tIdx = index"
                                    [value]="tIdx">
                                    {{type.translatedName}}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
                    
                    <!-- פרמטר extraBeam מיוחד עבור שולחן -->
                    <div *ngIf="isTable && param.name === 'extraBeam'">
                        <label style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <div class="param-box non-beam">
                            <mat-form-field appearance="outline">
                                <mat-label>{{param.translatedName}} - {{getUnitForParameter(param)}}</mat-label>
                                <input matInput type="number" [min]="param.min" [max]="param.max"
                                    [step]="getStep(param.type)" [(ngModel)]="param.default" 
                                    (blur)="updateParameterValue(param, param.default)"
                                    (keyup.enter)="updateParameterValue(param, param.default)"
          (input)="onParameterInputChange($event, param)">
                            </mat-form-field>
                        </div>
                    </div>
                    
                    <div *ngIf="param.type !== 'beamSingle' && param.name !== 'shelfs' && (!isTable || param.name !== 'height') && param.name !== 'extraBeam'">
                        <label
                            style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <div class="param-box non-beam">
                            <mat-form-field appearance="outline">
                                <mat-label>{{param.translatedName}} - {{getUnitForParameter(param)}}</mat-label>
                                <input matInput type="number" [min]="param.min" [max]="param.max"
                                    [step]="getStep(param.type)" [(ngModel)]="param.default" 
                                    (blur)="updateParameterValue(param, param.default)"
                                    (keyup.enter)="updateParameterValue(param, param.default)"
          (input)="onParameterInputChange($event, param)">
                            </mat-form-field>
                        </div>
                    </div>
                </div>
                
                <!-- שדה כמות יחידות -->
                <div class="quantity-selector">
                    <label class="quantity-label">כמות יחידות:</label>
                    <div class="quantity-control">
                        <button class="quantity-btn minus" (click)="decreaseQuantity()" [disabled]="quantity <= 1">
                            <svg width="12" height="12" viewBox="0 0 12 12">
                                <line x1="3" y1="6" x2="9" y2="6" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </button>
                        <input 
                            type="number" 
                            class="quantity-input" 
                            [(ngModel)]="quantity" 
                            (change)="onQuantityChange($event)"
                            min="1">
                        <button class="quantity-btn plus" (click)="increaseQuantity()">
                            <svg width="12" height="12" viewBox="0 0 12 12">
                                <line x1="6" y1="3" x2="6" y2="9" stroke="currentColor" stroke-width="2"/>
                                <line x1="3" y1="6" x2="9" y2="6" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- טבלת מידות המוצר -->
                <div class="product-dimensions-container">
                    <h3>מידות המוצר הסופי</h3>
                    <table class="dimensions-table">
                        <tr>
                            <td>אורך כולל:</td>
                            <td [innerHTML]="getProductDimensions().length"></td>
                        </tr>
                        <tr>
                            <td>רוחב כולל:</td>
                            <td [innerHTML]="getProductDimensions().width"></td>
                        </tr>
                        <tr>
                            <td>גובה כולל:</td>
                            <td [innerHTML]="getProductDimensions().height"></td>
                        </tr>
                        <tr>
                            <td>כמות קורות במדף:</td>
                            <td [innerHTML]="getProductDimensions().beamCount"></td>
                        </tr>
                        <tr>
                            <td>רווח בין קורות המדף:</td>
                            <td [innerHTML]="getProductDimensions().gapBetweenBeams"></td>
                        </tr>
                        <tr>
                            <td>כמות מדפים:</td>
                            <td [innerHTML]="getProductDimensions().shelfCount"></td>
                        </tr>
                        <tr *ngIf="!isTable">
                            <td>גבהי המדפים:</td>
                            <td [innerHTML]="getProductDimensions().shelfHeights"></td>
                        </tr>
                    </table>
                </div>
                </div> <!-- סיום התוכן הרגיל -->
            </ng-container>
        </div>
        <div #rendererContainer class="renderer-container" [class.expanded]="!drawerOpen">
            <!-- Spinner במרכז התצוגה התלת-מימדית -->
            <div class="model-loading-spinner" *ngIf="isModelLoading">
                <div class="spinner"></div>
            </div>
            
            <!-- כפתור ניווט -->
            <div class="navigation-button">
                <!-- קוביה הבסיס -->
                <div class="base-cube">
                    <!-- כפתור TOP -->
                    <div class="nav-button top-button" 
                         (click)="onNavigationClick('top')"
                         [matTooltip]="'view_top' | translate"
                         matTooltipPosition="above"></div>
                    
                    <!-- כפתור BOTTOM -->
                    <div class="nav-button bottom-button" 
                         (click)="onNavigationClick('bottom')"
                         [matTooltip]="'view_bottom' | translate"
                         matTooltipPosition="above"></div>
                    
                    <!-- כפתור LEFT -->
                    <div class="nav-button left-button" 
                         (click)="onNavigationClick('left')"
                         [matTooltip]="'view_left' | translate"
                         matTooltipPosition="above"></div>
                    
                    <!-- כפתור RIGHT -->
                    <div class="nav-button right-button" 
                         (click)="onNavigationClick('right')"
                         [matTooltip]="'view_right' | translate"
                         matTooltipPosition="above"></div>
                    
                    <!-- כפתור FRONT -->
                    <div class="nav-button front-button" 
                         (click)="onNavigationClick('front')"
                         [matTooltip]="'view_front' | translate"
                         matTooltipPosition="above"></div>
                </div>
            </div>
        </div>
    </div>
    
    
    <!-- אזור חישוב המחיר -->
    <div class="price-calculation-area">
        <button class="fullscreen-btn" mat-icon-button color="primary" 
                [matTooltip]="!isPriceManuOpen ? ('price-calculation.tooltip' | translate) : ''" 
                matTooltipPosition="left"
                (click)="togglePriceMenu()"
                aria-label="מסך מלא">
            <mat-icon>fullscreen</mat-icon>
        </button>
        <div class="price-info">
            <div class="price-display">
                <span class="price-label">מחיר:</span>
                <div class="price-loader" *ngIf="calculatedPrice === 0">
                    <mat-spinner diameter="20"></mat-spinner>
                    <div style="width: 5px;"></div>
                </div>
                <div class="price-value-inline" *ngIf="calculatedPrice > 0">
                    {{ calculatedPrice }} ₪
                </div>
            </div>
        </div>
        
        <!-- קופסא נוספת שמופיעה כשהתפריט פתוח -->
        <div class="price-menu-box" 
             [class.with-warning]="hasHiddenBeams || hasNoMiddleBeams"
             *ngIf="isPriceManuOpen">
            <!-- כותרת דינמית -->
            <span class="thinking-text" *ngIf="!BeamsDataForPricing || BeamsDataForPricing.length === 0">{{ 'price-calculation.first-title' | translate }}...</span>
            <span class="main-title" *ngIf="BeamsDataForPricing && BeamsDataForPricing.length > 0">חומרי גלם:</span>
            
            <!-- סיכום קורות -->
            <div class="materials-summary" *ngIf="BeamsDataForPricing && BeamsDataForPricing.length > 0">
                <div class="sub-title">קורות:</div>
                <div *ngFor="let beamData of BeamsDataForPricing" class="beam-name">
                    <!-- כותרת סוג הקורה -->
                    <div class="pricing-title">{{ beamData.beamTranslatedName || beamData.beamName }} ({{ beamData.type.translatedName }})</div>
                    
                    <!-- רשימת המידות -->
                    <div *ngFor="let sizeData of beamData.totalSizes" class="size-item">
                        <span class="size-value">{{ sizeData.length }} ס"מ</span>
                        <span class="size-separator"></span>
                        <span class="size-count">{{ sizeData.count }} {{ 'price-calculation.units' | translate }}</span>
                    </div>
                </div>
            </div>
            
            <!-- סיכום ברגים -->
            <div class="materials-summary" *ngIf="ForgingDataForPricing && ForgingDataForPricing.length > 0">
                <div class="sub-title">ברגים:</div>
                <div class="beam-type-section">
                    <div *ngFor="let forgingData of ForgingDataForPricing" class="size-item">
                        <span class="size-value">{{ forgingData.length }} ס"מ</span>
                        <span class="size-separator"></span>
                        <span class="size-count">{{ forgingData.count }} {{ 'price-calculation.units' | translate }}</span>
                    </div>
                </div>
            </div>
            
            <!-- תוכנית חיתוך קורות -->
            <div class="materials-summary" *ngIf="cuttingPlan && cuttingPlan.length > 0">
                <div class="main-title">תוכנית חיתוך קורות:</div>
                <div *ngFor="let beam of cuttingPlan" class="beam-type-section">
                    <!-- כותרת קורה -->
                    <div class="beam-header">
                        <div class="beam-number">{{ beam.beamNumber }}</div>
                        <div class="beam-details-item">
                            <span class="beam-text">{{ beam.beamType }} ({{ beam.beamWoodType }}) {{ beam.beamLength }} ס"מ</span>
                            <span class="beam-separator" style="opacity: 0;"></span>
                            <span class="beam-price">{{ beam.beamPrice }}₪</span>
                        </div>
                    </div>
                    
                    <!-- רשימת החתיכות מקובצות לפי גודל -->
                    <div *ngFor="let cutGroup of getCutGroups(beam.cuts)" class="size-item">
                        <span class="size-value">{{ cutGroup.length }} ס"מ</span>
                        <span class="size-separator"></span>
                        <span class="size-count">{{ cutGroup.count }} {{ 'price-calculation.units' | translate }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>