<div class="threejs-box-wrapper">
    <!-- הודעת validation הוסרה - משתמשים ב-SnackBar -->
    
    <!-- קונטיינר לכפתורי תצוגה -->
    <div class="view-controls-container">
        <!-- כפתור להצגת wireframe - מוסתר במובייל -->
        <button class="wireframe-toggle hide-on-mobile" (click)="toggleWireframe()" 
                [class.active]="showWireframe" 
                matTooltip="הצג את מידות המוצר המלאות"
                matTooltipPosition="below">
            <!-- SVG Icon -->
            <svg width="12" height="12" viewBox="0 0 12 12" style="margin-left:8px;">
                <rect x="1" y="1" width="10" height="10" stroke="currentColor" stroke-width="0.8" fill="none"/>
                <line x1="1" y1="6" x2="11" y2="6" stroke="currentColor" stroke-width="0.8"/>
                <line x1="6" y1="1" x2="6" y2="11" stroke="currentColor" stroke-width="0.8"/>
            </svg>
            <span class="button-text">{{ showWireframe ? ('hide_dimensions' | translate) : ('show_dimensions' | translate) }}</span>
        </button>
        
        <!-- כפתור תפריט אפשרויות נוספות -->
        <button class="options-menu-button" 
                [class.active]="isOptionsMenuOpen"
                [matMenuTriggerFor]="optionsMenu"
                #menuTrigger="matMenuTrigger"
                (menuOpened)="isOptionsMenuOpen = true"
                (menuClosed)="isOptionsMenuOpen = false"
                matTooltip="אפשרויות נוספות"
                matTooltipPosition="below">
            <svg width="12" height="12" viewBox="0 0 12 12">
                <circle cx="6" cy="2" r="1.2" fill="currentColor"/>
                <circle cx="6" cy="6" r="1.2" fill="currentColor"/>
                <circle cx="6" cy="10" r="1.2" fill="currentColor"/>
            </svg>
        </button>
    </div>
    
    <!-- תפריט אפשרויות נוספות -->
    <mat-menu #optionsMenu="matMenu" xPosition="after" class="custom-options-menu">
        <!-- אפשרות החלף מוצר -->
        <button mat-menu-item (click)="navigateToHome()" class="menu-option">
            <svg width="16" height="16" viewBox="0 0 16 16" class="menu-icon switch-product-icon">
                <!-- קוביה איזומטרית (30° view) ממורכזת - מוגדלת פי 1.7 -->
                <g transform="translate(8, 8) scale(1.7)">
                    <!-- דופן עליונה (מקבילית) -->
                    <path d="M 0,-3 L 3,-1.5 L 0,0 L -3,-1.5 Z" 
                          stroke="currentColor" 
                          stroke-width="0.5" 
                          fill="none">
                        <animate attributeName="d" 
                                 values="M 0,-3 L 3,-1.5 L 0,0 L -3,-1.5 Z;
                                         M 0,-3 L 4,-1.5 L 0,0 L -4,-1.5 Z;
                                         M 0,-3 L 3,-1.5 L 0,0 L -3,-1.5 Z;
                                         M 0,-4 L 3,-2.5 L 0,-1 L -3,-2.5 Z;
                                         M 0,-3 L 3,-1.5 L 0,0 L -3,-1.5 Z" 
                                 dur="3s" 
                                 repeatCount="indefinite"/>
                    </path>
                    <!-- דופן שמאל -->
                    <path d="M -3,-1.5 L -3,2.5 L 0,4 L 0,0 Z" 
                          stroke="currentColor" 
                          stroke-width="0.5" 
                          fill="none">
                        <animate attributeName="d" 
                                 values="M -3,-1.5 L -3,2.5 L 0,4 L 0,0 Z;
                                         M -4,-1.5 L -4,2.5 L 0,4 L 0,0 Z;
                                         M -3,-1.5 L -3,2.5 L 0,4 L 0,0 Z;
                                         M -3,-2.5 L -3,3.5 L 0,5 L 0,-1 Z;
                                         M -3,-1.5 L -3,2.5 L 0,4 L 0,0 Z" 
                                 dur="3s" 
                                 repeatCount="indefinite"/>
                    </path>
                    <!-- דופן ימין -->
                    <path d="M 3,-1.5 L 3,2.5 L 0,4 L 0,0 Z" 
                          stroke="currentColor" 
                          stroke-width="0.5" 
                          fill="none">
                        <animate attributeName="d" 
                                 values="M 3,-1.5 L 3,2.5 L 0,4 L 0,0 Z;
                                         M 4,-1.5 L 4,2.5 L 0,4 L 0,0 Z;
                                         M 3,-1.5 L 3,2.5 L 0,4 L 0,0 Z;
                                         M 3,-2.5 L 3,3.5 L 0,5 L 0,-1 Z;
                                         M 3,-1.5 L 3,2.5 L 0,4 L 0,0 Z" 
                                 dur="3s" 
                                 repeatCount="indefinite"/>
                    </path>
                </g>
            </svg>
            <span class="menu-text">החלף מוצר</span>
        </button>
        
        <!-- אפשרות הצג מידות - מוצג רק במובייל -->
        <button mat-menu-item (click)="toggleWireframe()" [class.active]="showWireframe" class="menu-option show-on-mobile">
            <svg width="12" height="12" viewBox="0 0 12 12" class="menu-icon">
                <rect x="1" y="1" width="10" height="10" stroke="currentColor" stroke-width="0.8" fill="none"/>
                <line x1="1" y1="6" x2="11" y2="6" stroke="currentColor" stroke-width="0.8"/>
                <line x1="6" y1="1" x2="6" y2="11" stroke="currentColor" stroke-width="0.8"/>
            </svg>
            <span class="menu-text">{{ showWireframe ? 'הסתר מידות' : 'הצג מידות' }}</span>
        </button>
        
        <!-- אפשרות מצב שקוף -->
        <button mat-menu-item (click)="toggleTransparentMode()" [class.active]="isTransparentMode" class="menu-option">
            <svg width="14" height="14" viewBox="0 0 14 14" class="menu-icon">
                <!-- ריבוע חיצוני שקוף -->
                <rect x="1.5" y="1.5" width="11" height="11" stroke="currentColor" stroke-width="1" fill="none" opacity="0.6"/>
                <!-- ריבוע פנימי שקוף יותר -->
                <rect x="4" y="4" width="6" height="6" stroke="currentColor" stroke-width="0.8" fill="currentColor" opacity="0.25"/>
                <!-- קווים אלכסוניים להדגשת שקיפות -->
                <line x1="2" y1="2" x2="12" y2="12" stroke="currentColor" stroke-width="0.6" opacity="0.4"/>
            </svg>
            <span class="menu-text">מצב שקוף</span>
        </button>
        
        <!-- אפשרות בחר מבט -->
        <button mat-menu-item (click)="toggleNavigationCube()" [class.active]="showNavigationCube" class="menu-option">
            <svg width="14" height="14" viewBox="0 0 14 14" class="menu-icon">
                <!-- קוביה איזומטרית -->
                <path d="M 7 2 L 12 4.5 L 12 9.5 L 7 12 L 2 9.5 L 2 4.5 Z" stroke="currentColor" stroke-width="1" fill="none"/>
                <line x1="7" y1="2" x2="7" y2="7" stroke="currentColor" stroke-width="1"/>
                <line x1="7" y1="7" x2="12" y2="9.5" stroke="currentColor" stroke-width="1"/>
                <line x1="7" y1="7" x2="2" y2="9.5" stroke="currentColor" stroke-width="1"/>
                <!-- נקודת מיקוד -->
                <circle cx="7" cy="7" r="1" fill="currentColor"/>
            </svg>
            <span class="menu-text">בחר מבט</span>
        </button>
    </mat-menu>
    
    <!-- קוביית ניווט במובייל -->
    <div class="mobile-navigation-cube" *ngIf="showNavigationCube" [@fadeInScale]>
        <div class="nav-cube-title">בחר מבט</div>
        
        <!-- קוביה עם כפתורים -->
        <div class="mobile-base-cube">
            <!-- כפתור למעלה -->
            <button class="mobile-nav-button mobile-top-button" (click)="onNavigationClick('top')">
                <span class="nav-text">למעלה</span>
            </button>
            
            <!-- כפתור שמאל -->
            <button class="mobile-nav-button mobile-left-button" (click)="onNavigationClick('left')">
                <span class="nav-text">שמאל</span>
            </button>
            
            <!-- כפתור קדמי (מרכז) -->
            <button class="mobile-nav-button mobile-front-button" (click)="onNavigationClick('front')">
                <span class="nav-text">קדמי</span>
            </button>
            
            <!-- כפתור ימין -->
            <button class="mobile-nav-button mobile-right-button" (click)="onNavigationClick('right')">
                <span class="nav-text">ימין</span>
            </button>
            
            <!-- כפתור תחתון -->
            <button class="mobile-nav-button mobile-back-button" (click)="onNavigationClick('bottom')">
                <span class="nav-text">למטה</span>
            </button>
        </div>
        
        <button class="nav-cube-close" (click)="toggleNavigationCube()">✕</button>
    </div>
    
    <!-- התרעה על קורות מוסתרות -->
    <div class="hidden-beams-warning" *ngIf="hasHiddenBeams && !hasNoMiddleBeams">
        <svg width="12" height="12" viewBox="0 0 12 12" style="margin-left:8px;">
            <circle cx="6" cy="6" r="5" stroke="currentColor" stroke-width="0.8" fill="none"/>
            <path d="M6 3v3M6 8h.01" stroke="currentColor" stroke-width="0.8" fill="none"/>
        </svg>
        <span class="button-text">{{ 'hidden_beams_warning' | translate }}</span>
    </div>
    
    <!-- התרעה על מקרה קיצון - אין קורות באמצע -->
    <div class="hidden-beams-warning critical" *ngIf="hasNoMiddleBeams">
        <svg width="12" height="12" viewBox="0 0 12 12" style="margin-left:8px;">
            <circle cx="6" cy="6" r="5" stroke="currentColor" stroke-width="0.8" fill="none"/>
            <path d="M6 3v3M6 8h.01" stroke="currentColor" stroke-width="0.8" fill="none"/>
        </svg>
        <span class="button-text">{{ 'no_middle_beams_warning' | translate }}</span>
    </div>
    
    <div class="main-flex-row">
        <div class="controls" [class.closed]="!drawerOpen">
            <button class="drawer-toggle" (click)="toggleDrawer()">
                <svg width="12" height="12" viewBox="0 0 12 12" style="display:block;margin:auto;">
                    <polyline points="4,2 8,6 4,10" stroke="#666" stroke-width="2" fill="none"
                        [attr.transform]="drawerOpen ? 'rotate(180 6 6)' : ''" />
                </svg>
            </button>
            <ng-container *ngIf="drawerOpen">
                <!-- Spinner Loading - מוצג רק בטעינה הראשונית -->
                <div class="loading-spinner" *ngIf="isLoading && isModelLoading">
                    <div class="spinner"></div>
                </div>
                
                <!-- כל התוכן הרגיל - מוצג תמיד -->
                <div>
                <!-- כותרת מוצר -->
                <div class="product-header" *ngIf="selectedProductName" style="margin-bottom: 20px;">
                    <h3 style="margin: 0; padding: 10px; text-align: center;">
                        {{product?.translatedName || selectedProductName}}<br>
                            <span style="margin-top: 8px; font-weight: normal; font-size: 0.8em; display: block; color: #0066cc;">דגם: {{product?.model || product?.name || selectedProductName}}</span>
                    </h3>
                </div>
                
                <div *ngFor="let param of params" class="param-box">
                    
                    <!-- טיפול בשולחן - פרמטר height -->
                    <div *ngIf="isTable && param.name === 'height'">
                        <label style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <mat-form-field appearance="outline">
                            <mat-label>{{param.translatedName}}</mat-label>
                            <input matInput type="number" [(ngModel)]="param.default" 
                                   [min]="param.min" [max]="param.max" 
                        (blur)="updateModel()"
                        (keyup.enter)="updateModel()"
                        (input)="onNumberInputChange($event, 'updateModel')">
                        </mat-form-field>
                    </div>
                    
                    <!-- טיפול בארון - פרמטר shelfs -->
                    <div *ngIf="!isTable && param.name === 'shelfs'">
                        <label
                            style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <div class="shelf-row">
                            <mat-form-field appearance="outline">
                                <mat-label>סוג קורה</mat-label>
                                <mat-select [(ngModel)]="param.selectedBeamIndex" (selectionChange)="updateBeams()">
                                    <mat-option *ngFor="let beam of param.beams; let bIdx = index" [value]="bIdx">
                                        {{beam.translatedName}}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline">
                                <mat-label>סוג עץ</mat-label>
                                <mat-select [(ngModel)]="param.selectedTypeIndex" (selectionChange)="updateBeams()">
                                    <mat-option
                                        *ngFor="let type of param.beams[param.selectedBeamIndex]?.types; let tIdx = index"
                                        [value]="tIdx">
                                        {{type.translatedName}}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="add-shelf-btn-container">
                            <button class="add-shelf-btn" (click)="param.default.push(param.min); updateBeams()">
                                <svg viewBox="0 0 16 16" width="14" height="14">
                                    <circle cx="8" cy="8" r="7" fill="#fff" />
                                    <line x1="8" y1="4" x2="8" y2="12" stroke="#333" stroke-width="2" />
                                    <line x1="4" y1="8" x2="12" y2="8" stroke="#333" stroke-width="2" />
                                </svg>
                            </button>
                        </div>
                        <div class="shelf-measurements-container beam-array-container">
                            <div *ngFor="let i of [].constructor(param.default.length); let idx = index" class="shelf-row">
                                <div class="shelf-gap-field-wrapper">
                                    <mat-form-field appearance="outline" class="shelf-gap-field">
                                        <mat-label>מידה {{param.default.length - idx}} - {{getUnitForParameter(param)}}</mat-label>
                                        <input matInput type="number" [min]="param.min" [max]="param.max" [step]="1"
                                            [(ngModel)]="param.default[param.default.length - 1 - idx]"
                                            (blur)="updateShelfParameterValue(param, param.default[param.default.length - 1 - idx], param.default.length - 1 - idx)"
                  (keyup.enter)="updateShelfParameterValue(param, param.default[param.default.length - 1 - idx], param.default.length - 1 - idx)"
                  (input)="onShelfInputChange($event, param, idx)">
                                    </mat-form-field>
                                    <button *ngIf="idx !== param.default.length - 1" class="remove-shelf-btn"
                                        (click)="param.default.splice(param.default.length - 1 - idx,1); updateBeams()"
                                        [disabled]="param.default.length<=1" aria-label="הסר מדף">
                                        <svg width="14" height="14" viewBox="0 0 14 14">
                                            <circle cx="7" cy="7" r="6" fill="#fff" stroke="#d32f2f" stroke-width="1.2" />
                                            <line x1="4.5" y1="4.5" x2="9.5" y2="9.5" stroke="#d32f2f" stroke-width="1.5" />
                                            <line x1="9.5" y1="4.5" x2="4.5" y2="9.5" stroke="#d32f2f" stroke-width="1.5" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
            
                        </div>
                    </div>
                    
                    <!-- טיפול במוצר קורות לפי מידה - פרמטר beams עם setAmount (בדיוק כמו קורות מדף של השולחן) -->
                    <div *ngIf="isBelams && param.name === 'beams' && param.setAmount">
                        <label style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <div class="shelf-row">
                            <mat-form-field appearance="outline">
                                <mat-label>סוג קורה</mat-label>
                                <mat-select [(ngModel)]="param.selectedBeamIndex" (selectionChange)="updateBeams()">
                                    <mat-option *ngFor="let beam of param.beams; let bIdx = index" [value]="bIdx">
                                        {{beam.translatedName}}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline">
                                <mat-label>סוג עץ</mat-label>
                                <mat-select [(ngModel)]="param.selectedTypeIndex" (selectionChange)="updateBeams()">
                                    <mat-option
                                        *ngFor="let type of param.beams[param.selectedBeamIndex || 0]?.types || []; let tIdx = index"
                                        [value]="tIdx">
                                        {{type.translatedName}}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="add-shelf-btn-container">
                            <button class="add-shelf-btn" (click)="addBeamWithAmount(param); updateBeams()">
                                <svg viewBox="0 0 16 16" width="14" height="14">
                                    <circle cx="8" cy="8" r="7" fill="#fff" />
                                    <line x1="8" y1="4" x2="8" y2="12" stroke="#333" stroke-width="2" />
                                    <line x1="4" y1="8" x2="12" y2="8" stroke="#333" stroke-width="2" />
                                </svg>
                            </button>
                        </div>
                        <div class="shelf-measurements-container beam-array-container">
                            <div *ngFor="let i of [].constructor(param.default.length); let idx = index" class="shelf-row">
                                <div class="shelf-gap-field-wrapper">
                                    <div class="beam-entry-container">
                                        <mat-form-field appearance="outline" class="shelf-gap-field-length">
                                            <mat-label>אורך {{param.default.length - idx}}</mat-label>
                                            <input matInput type="number" [min]="param.min" [max]="param.max" [step]="1"
                                                [(ngModel)]="param.default[param.default.length - 1 - idx].length"
                                                (blur)="updateShelfParameterValue(param, param.default[param.default.length - 1 - idx], param.default.length - 1 - idx)"
                                                (keyup.enter)="updateShelfParameterValue(param, param.default[param.default.length - 1 - idx], param.default.length - 1 - idx)"
                                                (input)="onShelfInputChange($event, param, idx)">
                                        </mat-form-field>
                                        <div class="quantity-container">
                                            <div class="quantity-label-above">כמות</div>
                                            <div class="quantity-control">
                                                <!-- במובייל: פלוס למעלה -->
                                                <button class="quantity-btn plus"
                                                        (click)="increaseAmount(param, idx)">
                                                    <svg width="12" height="12" viewBox="0 0 12 12">
                                                        <line x1="6" y1="4" x2="6" y2="8" stroke="currentColor" stroke-width="1.5"/>
                                                        <line x1="4" y1="6" x2="8" y2="6" stroke="currentColor" stroke-width="1.5"/>
                                                    </svg>
                                                </button>
                                                 <!-- באמצע: ערך הזנה -->
                                                 <input class="quantity-input"
                                                        type="number" 
                                                        [(ngModel)]="param.default[param.default.length - 1 - idx].amount"
                                                        (change)="updateShelfParameterValue(param, param.default[param.default.length - 1 - idx], param.default.length - 1 - idx)"
                                                        (keyup.enter)="updateShelfParameterValue(param, param.default[param.default.length - 1 - idx], param.default.length - 1 - idx)"
                                                        (input)="onShelfInputChange($event, param, idx)"
                                                        min="1">
                                                <!-- למטה: מינוס -->
                                                <button class="quantity-btn minus" 
                                                        (click)="decreaseAmount(param, idx)">
                                                    <svg width="12" height="12" viewBox="0 0 12 12">
                                                        <line x1="4" y1="6" x2="8" y2="6" stroke="currentColor" stroke-width="1.5"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <button *ngIf="idx !== param.default.length - 1" class="remove-shelf-btn"
                                        (click)="param.default.splice(param.default.length - 1 - idx,1); updateBeams()"
                                        [disabled]="param.default.length<=1" aria-label="הסר קורה">
                                        <svg width="14" height="14" viewBox="0 0 14 14">
                                            <circle cx="7" cy="7" r="6" fill="#fff" stroke="#d32f2f" stroke-width="1.2" />
                                            <line x1="4.5" y1="4.5" x2="9.5" y2="9.5" stroke="#d32f2f" stroke-width="1.5" />
                                            <line x1="9.5" y1="4.5" x2="4.5" y2="9.5" stroke="#d32f2f" stroke-width="1.5" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
            <style>
                .quantity-container {
                    --mat-mdc-text-field-wrapper-max-width: 120px !important;
                }
                /* החזרת גובה רגיל לאינפוטים של beamArray */
                .beam-entry-container .mat-mdc-form-field,
                .beam-entry-container .mat-mdc-text-field-wrapper,
                .beam-entry-container .mdc-text-field {
                    height: auto !important;
                    min-height: 56px !important;
                    max-height: 56px !important;
                }
                .beam-entry-container .mat-mdc-form-field-subscript-wrapper,
                .beam-entry-container .mat-mdc-form-field-bottom-align {
                    height: auto !important;
                    min-height: 13px !important;
                }
                .quantity-input-field {
                    height: auto !important;
                    min-height: 56px !important;
                    max-height: 56px !important;
                }
                .quantity-input-field .mat-mdc-text-field-wrapper,
                .quantity-input-field .mdc-text-field {
                    height: auto !important;
                    min-height: 56px !important;
                    max-height: 56px !important;
                }
                            .shelf-gap-field-wrapper {
                                display: flex !important;
                                align-items: center !important;
                                width: 100% !important;
                                flex-direction: row !important;
                            }
                            .beam-entry-container {
                                flex: 1 !important;
                                display: flex !important;
                                flex-direction: row !important;
                                align-items: center !important;
                            }
                             .shelf-gap-field-length {
                                 flex: 0 0 105px !important;
                                 max-width: 105px !important;
                                 width: 105px !important;
                                 margin-right: 8px !important;
                             }
                            .quantity-container {
                                display: flex !important;
                                flex-direction: column !important;
                                gap: 4px !important;
                                position: relative !important;
                            }
                            .quantity-label-above {
                                font-size: 13px !important;
                                color: #888 !important;
                                font-weight: 400 !important;
                                text-align: center !important;
                                position: absolute !important;
                                left: -77px !important;
                                top: -35px !important;
                                z-index: 15 !important;
                                width: 75px !important;
                                background: transparent !important;
                            }
                            .beam-entry-container mat-form-field.max-width-124 {
                                max-width: 124px !important;
                                width: 124px !important;
                            }
                             /* כללים ספציפיים רק למוצר קורות עם setAmount=true */
                             .beam-entry-container .shelf-gap-field-length,
                             .beam-entry-container .shelf-gap-field-length .mat-mdc-text-field-wrapper,
                             .beam-entry-container .shelf-gap-field-length .mdc-text-field {
                                 max-width: 105px !important;
                                 width: 105px !important;
                                 min-width: 105px !important;
                             }
                             /* הסרת חצים של spinner בsetAmount */
                             .beam-entry-container .shelf-gap-field-length input[type="number"] {
                                 -moz-appearance: textfield !important;
                             }
                             .beam-entry-container .shelf-gap-field-length input[type="number"]::-webkit-outer-spin-button,
                             .beam-entry-container .shelf-gap-field-length input[type="number"]::-webkit-inner-spin-button {
                                 -webkit-appearance: none !important;
                                 margin: 0 !important;
                             }
                            .beam-entry-container .mat-mdc-text-field-wrapper .mdc-text-field__native-control {
                                max-width: 124px !important;
                            }
                            .mdc-notched-outline,
                            .mdc-notched-outline--upgraded,
                            .mdc-notched-outline--notched {
                                max-width: 120px !important;
                                width: 120px !important;
                            }
                            .quantity-container .mdc-notched-outline {
                                max-width: 120px !important;
                                width: 120px !important;
                            }
                             .quantity-container input[type="number"] {
                                 max-width: 120px !important;
                                 width: 120px !important;
                             }
                             .quantity-input-field {
                                 max-width: 120px !important;
                                 width: 120px !important;
                                 min-width: 120px !important;
                                 flex: 0 0 120px !important;
                                 box-sizing: border-box !important;
                             }
                             .quantity-input {
                                 max-width: 120px !important;
                                 width: 120px !important;
                                 min-width: 120px !important;
                                 flex: 0 0 120px !important;
                                 box-sizing: border-box !important;
                             }
                             .max-width-124 {
                                 max-width: 120px !important;
                                 width: 120px !important;
                                 min-width: 120px !important;
                                 flex: 0 0 120px !important;
                             }
                             .quantity-container input,
                             .quantity-container mat-form-field,
                             .quantity-container .mat-mdc-form-field,
                             .quantity-container .mat-mdc-text-field-wrapper,
                             .quantity-container .mdc-text-field,
                             .quantity-container .mat-form-field-infix {
                                 max-width: 120px !important;
                                 width: 120px !important;
                             }
                             .quantity-container .mdc-notched-outline__leading,
                             .quantity-container .mdc-notched-outline__trailing {
                                 max-width: 120px !important;
                                 width: 120px !important;
                             }
                             .quantity-container .mat-mdc-text-field-wrapper.mdc-text-field,
                             .quantity-container .mat-mdc-text-field-wrapper.mdc-text-field--outlined {
                                 max-width: 120px !important;
                                 width: 120px !important;
                             }
                             .quantity-container .mat-mdc-text-field-wrapper.mdc-text-field.matic-text-field--outlined {
                                 max-width: 120px !important;
                                 width: 120px !important;
                             }
                             .quantity-container [class*="ng-tns-c1205077789-12"] .mat-mdc-text-field-wrapper,
                             .quantity-container [class*="ng-tns-c1205077789-12"] .mdc-text-field {
                                 max-width: 120px !important;
                                 width: 120px !important;
                             }
                             ::ng-deep .quantity-container .mat-mdc-text-field-wrapper,
                             ::ng-deep .quantity-container .mdc-text-field {
                                 max-width: 120px !important;
                                 width: 120px !important;
                             }
                             ::ng-deep .beam-entry-container .quantity-container .mat-mdc-text-field-wrapper,
                             ::ng-deep .beam-entry-container .quantity-container .mdc-text-field {
                                 max-width: 120px !important;
                                 width: 120px !important;
                             }
                             ::ng-deep .quantity-container .quantity-container .mat-mdc-text-field-wrapper,
                             ::ng-deep .quantity-container .quantity-container .mdc-text-field {
                                 max-width: 120px !important;
                                 width: 120px !important;
                             }
                             /* החזרת גובה רגיל עם ::ng-deep */
                             ::ng-deep .beam-entry-container .mat-mdc-text-field-wrapper,
                             ::ng-deep .beam-entry-container .mdc-text-field,
                             ::ng-deep .quantity-input-field .mat-mdc-text-field-wrapper,
                             ::ng-deep .quantity-input-field .mdc-text-field {
                                 height: 56px !important;
                                 max-height: 56px !important;
                             }
                             /* כללי חזקים יותר עבור אינפוט הכמות */
                             ::ng-deep .quantity-input-field,
                             ::ng-deep .quantity-input-field .mat-mdc-text-field-wrapper,
                             ::ng-deep .quantity-input-field .mdc-text-field,
                             ::ng-deep .quantity-input-field .mdc-notched-outline,
                             ::ng-deep .quantity-container .input[class*="quantity-input"],
                             ::ng-deep .quantity-container input.max-width-124,
                             ::ng-deep .quantity-container input,
                             /* כללי חזקים עבור אינפוט האורך */
                             ::ng-deep .shelf-gap-field-length,
                             ::ng-deep .shelf-gap-field-length .mat-mdc-text-field-wrapper,
                             ::ng-deep .shelf-gap-field-length .mdc-text-field,
                             ::ng-deep .shelf-gap-field-length .mdc-notched-outline {
                                 max-width: 105px !important;
                                 width: 105px !important;
                                 min-width: 105px !important;
                                 flex: 0 0 105px !important;
                             }
                             /* הגבלה רוחב חזקה עבור אינפוט כמות */
                             ::ng-deep .beam-entry-container .quantity-input,
                             ::ng-deep .beam-entry-container input[type="number"],
                             ::ng-deep .beam-entry-container input.quantity-input {
                                 width: 35px !important;
                                 max-width: 35px !important;
                                 min-width: 35px !important;
                                 flex: 0 0 35px !important;
                             }
                            /* רק עבור כמות בתוך beamArray */
                            .beam-entry-container .quantity-control {
                                display: flex !important;
                                align-items: center !important;
                                gap: 3px !important;
                                position: absolute !important;
                                left: -112px !important;
                                top: 50% !important;
                                transform: translateY(-29%) translateY(5px) !important;
                                z-index: 10 !important;
                            }
                             /* רק עבור אינפוט כמות בתוך beamArray */
                             .beam-entry-container .quantity-input {
                                 width: 35px !important;
                                 max-width: 35px !important;
                                 min-width: 35px !important;
                                 text-align: center !important;
                                 padding: 3px 1px !important;
                                 border: 1px solid #ccc !important;
                                 border-radius: 2px !important;
                                 font-size: 12px !important;
                                 background: #fff !important;
                                 box-sizing: border-box !important;
                             }
                             /* הסרת חצים של spinner באינפוט כמות רגיל */
                             .beam-entry-container .quantity-input {
                                 -moz-appearance: textfield !important;
                             }
                             .beam-entry-container .quantity-input::-webkit-outer-spin-button,
                             .beam-entry-container .quantity-input::-webkit-inner-spin-button {
                                 -webkit-appearance: none !important;
                                 margin: 0 !important;
                             }
                            .max-width-124 {
                                max-width: 124px !important;
                                width: 124px !important;
                            }
                            /* רק עבור כפתורי כמות בתוך beamArray - עיצוב פשוט */
                            .beam-entry-container .quantity-btn {
                                width: 20px !important;
                                height: 20px !important;
                                border: 1px solid #ccc !important;
                                background: #f8f9fa !important;
                                cursor: pointer !important;
                                font-size: 12px !important;
                                padding: 0 !important;
                                margin: 0 !important;
                                display: flex !important;
                                align-items: center !important;
                                justify-content: center !important;
                                border-radius: 2px !important;
                                color: #333 !important;
                            }
                            /* הובר פשוט */
                            .beam-entry-container .quantity-btn:hover {
                                background: #e9ecef !important;
                                border-color: #999 !important;
                            }
                            .remove-shelf-btn {
                                flex: 0 0 24px !important;
                                margin-left: 8px !important;
                            }
                        </style>
                        <!-- כללים למובייל -->
                        <style>
                            @media (max-width: 768px) {
                                /* מבנה אנכי של אינפוט הכמות במובייל */
                                .beam-entry-container .quantity-control {
                                    left: -42px !important; /* -112px + 70px */
                                    top: 50% !important;
                                    transform: translateY(-50%) !important;
                                    flex-direction: column !important;
                                    gap: 1px !important;
                                    align-items: center !important;
                                    width: 25px !important;
                                    max-width: 25px !important;
                                }
                                /* קטנת הכפתורים והאינבוט במובייל ללא גבולות */
                                .beam-entry-container .quantity-btn {
                                    width: 20px !important;
                                    height: 18px !important;
                                    min-width: 20px !important;
                                    border: none !important;
                                    background: rgba(0,0,0,0.05) !important;
                                    border-radius: 2px !important;
                                }
                                .beam-entry-container .quantity-input {
                                    width: 20px !important;
                                    max-width: 20px !important;
                                    padding: 2px !important;
                                    font-size: 11px !important;
                                    border: none !important;
                                    background: rgba(0,0,0,0.02) !important;
                                    border-radius: 2px !important;
                                }
                                .beam-entry-container .quantity-control {
                                    border: none !important;
                                    background: transparent !important;
                                    box-shadow: none !important;
                                }
                                .quantity-label-above {
                                    display: none !important;
                                }
                                /* קטנת רוחב האינפוט הפנימי של האורך במובייל */
                                .beam-entry-container .shelf-gap-field-length input[type="number"],
                                .beam-entry-container .shelf-gap-field-length .mat-mdc-text-field__native-control,
                                .beam-entry-container .shelf-gap-field-length .mat-input-element {
                                    max-width: 80px !important; /* 105px - 25px */
                                    width: 80px !important;
                                }
                                .shelf-gap-field-length {
                                    flex: 0 0 80px !important; /* 105px - 25px */
                                }
                            }
                        </style>
                    </div>
                    
                    <!-- טיפול בשולחן - פרמטר plata -->
                    <div *ngIf="isTable && param.name === 'plata'">
                        <label style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <div class="shelf-row">
                            <mat-form-field appearance="outline">
                                <mat-label>סוג קורה</mat-label>
                                <mat-select [(ngModel)]="param.selectedBeamIndex" (selectionChange)="updateBeams()">
                                    <mat-option *ngFor="let beam of param.beams; let bIdx = index" [value]="bIdx">
                                        {{beam.translatedName}}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline">
                                <mat-label>סוג עץ</mat-label>
                                <mat-select [(ngModel)]="param.selectedTypeIndex" (selectionChange)="updateBeams()">
                                    <mat-option *ngFor="let type of param.beams[param.selectedBeamIndex || 0]?.types || []; let tIdx = index" [value]="tIdx">
                                        {{type.translatedName}}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                    </div>
                    
                    <div *ngIf="param.type === 'beamSingle' && (!isTable || param.name !== 'plata')">
                        <label
                            style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <mat-form-field appearance="outline">
                            <mat-label>סוג קורה</mat-label>
                            <mat-select [(ngModel)]="param.selectedBeamIndex" (selectionChange)="updateBeams()">
                                <mat-option *ngFor="let beam of param.beams; let bIdx = index" [value]="bIdx">
                                    {{beam.translatedName}}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                        <mat-form-field appearance="outline">
                            <mat-label>סוג עץ</mat-label>
                            <mat-select [(ngModel)]="param.selectedTypeIndex" (selectionChange)="updateBeams()">
                                <mat-option
                                    *ngFor="let type of param.beams[param.selectedBeamIndex]?.types; let tIdx = index"
                                    [value]="tIdx">
                                    {{type.translatedName}}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
                    
                    <!-- פרמטר extraBeam מיוחד עבור שולחן -->
                    <div *ngIf="isTable && param.name === 'extraBeam'">
                        <label style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <div class="param-box non-beam">
                            <mat-form-field appearance="outline">
                                <mat-label>{{param.translatedName}} - {{getUnitForParameter(param)}}</mat-label>
                                <input matInput type="number" [min]="param.min" [max]="param.max"
                                    [step]="getStep(param.type)" [(ngModel)]="param.default" 
                                    (blur)="updateParameterValue(param, param.default)"
                                    (keyup.enter)="updateParameterValue(param, param.default)"
          (input)="onParameterInputChange($event, param)">
                            </mat-form-field>
                        </div>
                    </div>
                    
                    <!-- פרמטר boolean (toggle) -->
                    <div *ngIf="param.type === 'boolian' && (param.name !== 'openCover' || getParam('isCover')?.default === true)" class="boolean-param">
                        <span class="boolean-label">{{param.translatedName}}</span>
                        <mat-slide-toggle 
                            [(ngModel)]="param.default"
                            (change)="updateBeams()"
                            color="primary">
                        </mat-slide-toggle>
                    </div>
                    
                    
                    <div *ngIf="param.type !== 'beamSingle' && param.type !== 'boolian' && param.name !== 'shelfs' && (!isTable || param.name !== 'height') && param.name !== 'extraBeam'">
                        <label
                            style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <div class="param-box non-beam">
                            <mat-form-field appearance="outline">
                                <mat-label>{{param.translatedName}} - {{getUnitForParameter(param)}}</mat-label>
                                <input matInput type="number" [min]="param.min" [max]="param.max"
                                    [step]="getStep(param.type)" [(ngModel)]="param.default" 
                                    (blur)="updateParameterValue(param, param.default)"
                                    (keyup.enter)="updateParameterValue(param, param.default)"
          (input)="onParameterInputChange($event, param)">
                            </mat-form-field>
                        </div>
                    </div>
                </div>
                
                <!-- שדה כמות יחידות -->
                <div class="quantity-selector">
                    <label class="quantity-label">כמות יחידות:</label>
                    <div class="quantity-control">
                        <button class="quantity-btn minus" (click)="decreaseQuantity()" [disabled]="quantity <= 1">
                            <svg width="12" height="12" viewBox="0 0 12 12">
                                <line x1="3" y1="6" x2="9" y2="6" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </button>
                        <input 
                            type="number" 
                            class="quantity-input" 
                            [(ngModel)]="quantity" 
                            (change)="onQuantityChange($event)"
                            min="1">
                        <button class="quantity-btn plus" (click)="increaseQuantity()">
                            <svg width="12" height="12" viewBox="0 0 12 12">
                                <line x1="6" y1="3" x2="6" y2="9" stroke="currentColor" stroke-width="2"/>
                                <line x1="3" y1="6" x2="9" y2="6" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- טבלת מידות המוצר -->
                <div class="product-dimensions-container" *ngIf="!isLoading">
                    <h3>מידות המוצר הסופי</h3>
                    <table class="dimensions-table">
                        <tr>
                            <td>אורך כולל:</td>
                            <td [innerHTML]="getProductDimensions().length"></td>
                        </tr>
                        <tr>
                            <td>רוחב כולל:</td>
                            <td [innerHTML]="getProductDimensions().width"></td>
                        </tr>
                        <tr>
                            <td>גובה כולל:</td>
                            <td [innerHTML]="getProductDimensions().height"></td>
                        </tr>
                        <tr>
                            <td>כמות קורות במדף:</td>
                            <td [innerHTML]="getProductDimensions().beamCount"></td>
                        </tr>
                        <tr>
                            <td>רווח בין קורות המדף:</td>
                            <td [innerHTML]="getProductDimensions().gapBetweenBeams"></td>
                        </tr>
                        <tr>
                            <td>כמות מדפים:</td>
                            <td [innerHTML]="getProductDimensions().shelfCount"></td>
                        </tr>
                        <tr *ngIf="!isTable && !isBelams">
                            <td>גבהי המדפים:</td>
                            <td [innerHTML]="getProductDimensions().shelfHeights"></td>
                        </tr>
                        <!-- מידע מיוחד למוצר קורות -->
                        <tr *ngIf="isBelams">
                            <td>מידות קורות (עם כמות):</td>
                            <td [innerHTML]="getBelamsWithQuantitiesText()"></td>
                        </tr>
                    </table>
                </div>
                
                <!-- אלמנט ריק להבטחת גלילה מלאה -->
                <div class="scroll-spacer"></div>
                </div> <!-- סיום התוכן הרגיל -->
            </ng-container>
        </div>
        <div #rendererContainer class="renderer-container" [class.expanded]="!drawerOpen">
            <!-- Spinner במרכז התצוגה התלת-מימדית -->
            <div class="model-loading-spinner" *ngIf="isModelLoading">
                <div class="spinner"></div>
            </div>
            
            <!-- כפתור ניווט -->
            <div class="navigation-button">
                <!-- קוביה הבסיס -->
                <div class="base-cube">
                    <!-- כפתור TOP -->
                    <div class="nav-button top-button" 
                         (click)="onNavigationClick('top')"
                         [matTooltip]="'view_top' | translate"
                         matTooltipPosition="above"></div>
                    
                    <!-- כפתור BOTTOM -->
                    <div class="nav-button bottom-button" 
                         (click)="onNavigationClick('bottom')"
                         [matTooltip]="'view_bottom' | translate"
                         matTooltipPosition="above"></div>
                    
                    <!-- כפתור LEFT -->
                    <div class="nav-button left-button" 
                         (click)="onNavigationClick('left')"
                         [matTooltip]="'view_left' | translate"
                         matTooltipPosition="above"></div>
                    
                    <!-- כפתור RIGHT -->
                    <div class="nav-button right-button" 
                         (click)="onNavigationClick('right')"
                         [matTooltip]="'view_right' | translate"
                         matTooltipPosition="above"></div>
                    
                    <!-- כפתור FRONT -->
                    <div class="nav-button front-button" 
                         (click)="onNavigationClick('front')"
                         [matTooltip]="'view_front' | translate"
                         matTooltipPosition="above"></div>
                </div>
            </div>
        </div>
    </div>
    
    
    <!-- אזור חישוב המחיר -->
    <div class="price-calculation-area" [class.minimized]="isPriceMinimized">
        <!-- כפתור צמצום/הרחב -->
        <button class="minimize-btn" mat-icon-button 
                [matTooltip]="isPriceMinimized ? 'הרחב' : 'צמצם'"
                matTooltipPosition="above"
                (click)="togglePriceMinimize()"
                [class.expanded-mode]="isPriceMinimized"
                aria-label="צמצם/הרחב">
            <mat-icon>{{ isPriceMinimized ? 'unfold_more' : 'close' }}</mat-icon>
        </button>
        
        <button class="fullscreen-btn" mat-icon-button color="primary" 
                [matTooltip]="!isPriceManuOpen ? ('price-calculation.tooltip' | translate) : ''" 
                matTooltipPosition="above"
                (click)="togglePriceMenu()"
                *ngIf="!isPriceMinimized"
                aria-label="מסך מלא">
            <mat-icon>fullscreen</mat-icon>
        </button>
        <div class="price-info">
            <div class="price-display-wrapper">
                <!-- כפתור בחירת אופציה -->
                <button class="pricing-option-button" 
                        [matMenuTriggerFor]="pricingOptionsMenu"
                        *ngIf="calculatedPrice > 0 && !isPriceMinimized">
                    <div class="option-name-small">
                        {{ getPricingOptionName() }}
                        <svg class="edit-icon" width="12" height="12" viewBox="0 0 12 12">
                            <path d="M 8.5 1 L 11 3.5 L 4 10.5 L 1 11 L 1.5 8 Z" 
                                  stroke="#0066cc" 
                                  stroke-width="1" 
                                  fill="none" 
                                  stroke-linejoin="round"/>
                            <line x1="7.5" y1="2" x2="10" y2="4.5" stroke="#0066cc" stroke-width="0.8"/>
                        </svg>
                    </div>
                    
                    <!-- קפסולות פירוט מחיר -->
                    <div class="price-capsules">
                        <div class="price-capsule">
                            <div class="capsule-label">שרטוט</div>
                            <div class="capsule-value"><span class="currency-symbol">₪</span>{{ drawingPrice }}</div>
                        </div>
                        <div class="price-capsule" *ngIf="selectedPricingOption === 'cut' || selectedPricingOption === 'full'">
                            <div class="capsule-label">קורות</div>
                            <div class="capsule-value"><span class="currency-symbol">₪</span>{{ getBeamsOnlyPrice() }}</div>
                        </div>
                        <div class="price-capsule" *ngIf="selectedPricingOption === 'cut'">
                            <div class="capsule-label">חיתוך</div>
                            <div class="capsule-value"><span class="currency-symbol">₪</span>{{ getCuttingPrice() }}</div>
                        </div>
                    </div>
                    
                    <div class="price-display">
                        <!-- קונטיינר פנימי למחיר בלבד -->
                        <div class="price-only-wrapper">
                            <span class="price-label">מחיר:</span>
                            <div class="price-value-inline">
                                {{ getFinalPrice() }} ₪
                            </div>
                        </div>
                        
                        <!-- כפתור המשך -->
                        <button class="continue-button" 
                                (click)="onContinueOrder(); $event.stopPropagation()"
                                *ngIf="calculatedPrice > 0"
                                [@fadeInScale]>
                            <span class="continue-text">המשך</span>
                            <svg class="continue-arrow" width="14" height="14" viewBox="0 0 14 14">
                                <path d="M 2 7 L 10 7 M 7 3 L 11 7 L 7 11" stroke="currentColor" stroke-width="1.8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </button>
                
                <!-- תצוגת טעינה -->
                <div class="price-loader" *ngIf="calculatedPrice === 0">
                    <mat-spinner diameter="20"></mat-spinner>
                    <span class="calculating-text">מחשב מחיר...</span>
                </div>
                
                <!-- כפתור המשך מצומצם -->
                <button class="minimized-continue-button" 
                        (click)="togglePriceMinimize()"
                        *ngIf="isPriceMinimized && calculatedPrice > 0"
                        [@fadeInScale]>
                    <span class="minimized-text">המשך</span>
                    <span class="minimized-price">({{ getFinalPrice() }}₪)</span>
                    <svg class="minimized-arrow" width="14" height="14" viewBox="0 0 14 14">
                        <path d="M 2 7 L 10 7 M 7 3 L 11 7 L 7 11" stroke="currentColor" stroke-width="1.8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- תפריט אופציות תמחור -->
        <mat-menu #pricingOptionsMenu="matMenu" class="pricing-options-menu">
            <!-- כותרת התפריט -->
            <div class="pricing-menu-header">
                <svg width="22" height="22" viewBox="0 0 22 22" class="header-icon">
                    <!-- בועת דיבור -->
                    <path d="M 3 4 Q 3 3 4 3 L 18 3 Q 19 3 19 4 L 19 13 Q 19 14 18 14 L 8 14 L 5 17 L 5 14 L 4 14 Q 3 14 3 13 Z" 
                          stroke="#0066cc" 
                          stroke-width="1.2" 
                          fill="none"/>
                    <!-- סימני שאלה/אפשרויות -->
                    <text x="7" y="10" font-size="8" fill="#0066cc" font-weight="600">?</text>
                    <circle cx="11" cy="8.5" r="0.8" fill="#0066cc"/>
                    <circle cx="14" cy="8.5" r="0.8" fill="#0066cc"/>
                </svg>
                <div class="header-text">
                    <div class="header-title">בחרו אופציית הזמנה</div>
                    <div class="header-subtitle">קורות חתוכות, שלמות, או רק שרטוטים?</div>
                </div>
            </div>
            
            <!-- אופציה 1: קורות חתוכות -->
            <button mat-menu-item (click)="selectPricingOption('cut')" [class.selected]="selectedPricingOption === 'cut'">
                <div class="pricing-menu-item">
                    <div class="option-title-row">
                        <svg width="16" height="16" viewBox="0 0 16 16" class="check-icon" *ngIf="selectedPricingOption === 'cut'">
                            <!-- מסגרת checkbox -->
                            <rect x="1" y="1" width="14" height="14" rx="3" stroke="#0066cc" stroke-width="1.2" fill="none"/>
                            <!-- סימן V בכתב יד -->
                            <path class="check-path" d="M 4 8 L 7 11 L 12 5" stroke="#0066cc" stroke-width="1.8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <div class="option-title">קורות חתוכות לפי מידה</div>
                    </div>
                    <div class="menu-capsules">
                        <div class="menu-capsule">
                            <div class="menu-capsule-label">שרטוט</div>
                            <div class="menu-capsule-value">₪{{ drawingPrice }}</div>
                        </div>
                        <div class="menu-capsule">
                            <div class="menu-capsule-label">קורות</div>
                            <div class="menu-capsule-value">₪{{ getBeamsOnlyPrice() }}</div>
                        </div>
                        <div class="menu-capsule">
                            <div class="menu-capsule-label">חיתוך</div>
                            <div class="menu-capsule-value">₪{{ getCuttingPrice() }}</div>
                        </div>
                    </div>
                    <div class="option-total">סה"כ: {{ getBeamsOnlyPrice() + getCuttingPrice() + drawingPrice }}₪</div>
                </div>
            </button>
            
            <!-- אופציה 2: קורות שלמות + הוראות -->
            <button mat-menu-item (click)="selectPricingOption('full')" [class.selected]="selectedPricingOption === 'full'">
                <div class="pricing-menu-item">
                    <div class="option-title-row">
                        <svg width="16" height="16" viewBox="0 0 16 16" class="check-icon" *ngIf="selectedPricingOption === 'full'">
                            <!-- מסגרת checkbox -->
                            <rect x="1" y="1" width="14" height="14" rx="3" stroke="#0066cc" stroke-width="1.2" fill="none"/>
                            <!-- סימן V בכתב יד -->
                            <path class="check-path" d="M 4 8 L 7 11 L 12 5" stroke="#0066cc" stroke-width="1.8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <div class="option-title">קורות שלמות והוראות חיתוך</div>
                    </div>
                    <div class="menu-capsules">
                        <div class="menu-capsule">
                            <div class="menu-capsule-label">שרטוט</div>
                            <div class="menu-capsule-value">₪{{ drawingPrice }}</div>
                        </div>
                        <div class="menu-capsule">
                            <div class="menu-capsule-label">קורות</div>
                            <div class="menu-capsule-value">₪{{ getBeamsOnlyPrice() }}</div>
                        </div>
                    </div>
                    <div class="option-total">סה"כ: {{ getBeamsOnlyPrice() + drawingPrice }}₪</div>
                </div>
            </button>
            
            <!-- אופציה 3: הוראות בלבד -->
            <button mat-menu-item (click)="selectPricingOption('plan')" [class.selected]="selectedPricingOption === 'plan'">
                <div class="pricing-menu-item">
                    <div class="option-title-row">
                        <svg width="16" height="16" viewBox="0 0 16 16" class="check-icon" *ngIf="selectedPricingOption === 'plan'">
                            <!-- מסגרת checkbox -->
                            <rect x="1" y="1" width="14" height="14" rx="3" stroke="#0066cc" stroke-width="1.2" fill="none"/>
                            <!-- סימן V בכתב יד -->
                            <path class="check-path" d="M 4 8 L 7 11 L 12 5" stroke="#0066cc" stroke-width="1.8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <div class="option-title">הוראות חיתוך בלבד</div>
                    </div>
                    <div class="menu-capsules">
                        <div class="menu-capsule">
                            <div class="menu-capsule-label">שרטוט</div>
                            <div class="menu-capsule-value">₪{{ drawingPrice }}</div>
                        </div>
                    </div>
                    <div class="option-total">סה"כ: {{ drawingPrice }}₪</div>
                </div>
            </button>
        </mat-menu>
        
        <!-- קופסא נוספת שמופיעה כשהתפריט פתוח -->
        <div class="price-menu-box" 
             [class.with-warning]="hasHiddenBeams || hasNoMiddleBeams"
             *ngIf="isPriceManuOpen">
            <!-- כותרת דינמית -->
            <span class="thinking-text" *ngIf="!BeamsDataForPricing || BeamsDataForPricing.length === 0">{{ 'price-calculation.first-title' | translate }}...</span>
            <span class="main-title" *ngIf="BeamsDataForPricing && BeamsDataForPricing.length > 0">חומרי גלם:</span>
            
            <!-- סיכום קורות -->
            <div class="materials-summary" *ngIf="BeamsDataForPricing && BeamsDataForPricing.length > 0">
                <div class="sub-title">קורות:</div>
                <div *ngFor="let beamData of BeamsDataForPricing" class="beam-name">
                    <!-- כותרת סוג הקורה -->
                    <div class="pricing-title">{{ beamData.beamTranslatedName || beamData.beamName }} ({{ beamData.type.translatedName }})</div>
                    
                    <!-- רשימת המידות -->
                    <div *ngFor="let sizeData of beamData.totalSizes" class="size-item">
                        <span class="size-value">{{ sizeData.length }} ס"מ</span>
                        <span class="size-separator"></span>
                        <span class="size-count">{{ sizeData.count }} {{ 'price-calculation.units' | translate }}</span>
                    </div>
                </div>
            </div>
            
            <!-- סיכום ברגים -->
            <div class="materials-summary" *ngIf="ForgingDataForPricing && ForgingDataForPricing.length > 0">
                <div class="sub-title">ברגים:</div>
                <div class="beam-type-section">
                    <div *ngFor="let forgingData of ForgingDataForPricing" class="size-item">
                        <span class="size-value">{{ forgingData.length }} ס"מ</span>
                        <span class="size-separator"></span>
                        <span class="size-count">{{ forgingData.count }} {{ 'price-calculation.units' | translate }}</span>
                    </div>
                </div>
            </div>
            
            <!-- תוכנית חיתוך קורות -->
            <div class="materials-summary" *ngIf="cuttingPlan && cuttingPlan.length > 0">
                <div class="main-title">תוכנית חיתוך קורות:</div>
                <div *ngFor="let beam of cuttingPlan" class="beam-type-section">
                    <!-- כותרת קורה -->
                    <div class="beam-header">
                        <div class="beam-number">{{ beam.beamNumber }}</div>
                        <div class="beam-details-item">
                            <span class="beam-text">{{ beam.beamType }} ({{ beam.beamWoodType }}) {{ beam.beamLength }} ס"מ</span>
                            <span class="beam-separator" style="opacity: 0;"></span>
                            <span class="beam-price">{{ beam.beamPrice }}₪</span>
                        </div>
                    </div>
                    
                    <!-- רשימת החתיכות מקובצות לפי גודל -->
                    <div *ngFor="let cutGroup of getCutGroups(beam.cuts)" class="size-item">
                        <span class="size-value">{{ cutGroup.length }} ס"מ</span>
                        <span class="size-separator"></span>
                        <span class="size-count">{{ cutGroup.count }} {{ 'price-calculation.units' | translate }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>