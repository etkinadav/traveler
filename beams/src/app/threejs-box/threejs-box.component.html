<div class="threejs-box-wrapper">
    <!-- הודעת validation הוסרה - משתמשים ב-SnackBar -->
    
    <!-- קונטיינר לכפתורי תצוגה -->
    <div class="view-controls-container">
        <!-- כפתור להצגת wireframe - מוסתר במובייל ובמוצר קורות -->
        <button class="wireframe-toggle hide-on-mobile" (click)="toggleWireframe()" 
                [class.active]="showWireframe" 
                matTooltip="הצג את מידות המוצר המלאות"
                matTooltipPosition="below"
                *ngIf="!isBelams">
            <!-- SVG Icon -->
            <svg width="12" height="12" viewBox="0 0 12 12" style="margin-left:8px;">
                <rect x="1" y="1" width="10" height="10" stroke="currentColor" stroke-width="0.8" fill="none"/>
                <line x1="1" y1="6" x2="11" y2="6" stroke="currentColor" stroke-width="0.8"/>
                <line x1="6" y1="1" x2="6" y2="11" stroke="currentColor" stroke-width="0.8"/>
            </svg>
            <span class="button-text">{{ showWireframe ? ('hide_dimensions' | translate) : ('show_dimensions' | translate) }}</span>
        </button>
        
        <!-- כפתור תפריט אפשרויות נוספות -->
        <button class="options-menu-button" 
                [class.active]="isOptionsMenuOpen"
                (click)="isOptionsMenuOpen = !isOptionsMenuOpen"
                matTooltip="אפשרויות נוספות"
                matTooltipPosition="below">
            <svg width="12" height="12" viewBox="0 0 12 12">
                <circle cx="6" cy="2" r="1.2" fill="currentColor"/>
                <circle cx="6" cy="6" r="1.2" fill="currentColor"/>
                <circle cx="6" cy="10" r="1.2" fill="currentColor"/>
            </svg>
        </button>
    </div>
    
    <!-- תפריט אפשרויות נוספות -->
    <div class="custom-menu" [class.open]="isOptionsMenuOpen" *ngIf="isOptionsMenuOpen">
        <!-- אפשרות החלף מוצר -->
        <button class="menu-option" (click)="navigateToHome(); isOptionsMenuOpen = false">
            <svg width="18" height="18" viewBox="0 0 12 12" style="margin-left: 8px; margin-top: 5px;">
                <!-- חץ דו-כיווני פשוט -->
                <path d="M3 6L1 4L3 2" stroke="currentColor" stroke-width="0.8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M9 6L11 4L9 2" stroke="currentColor" stroke-width="0.8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="1" y1="4" x2="11" y2="4" stroke="currentColor" stroke-width="0.8"/>
            </svg>
            <span>{{ 'change_product' | translate }}</span>
        </button>
        
        <!-- אפשרות הצגת wireframe - מוסתרת במובייל ובמוצר קורות -->
        <button class="menu-option show-on-mobile" 
                (click)="toggleWireframe(); isOptionsMenuOpen = false" 
                [class.active]="showWireframe" 
                *ngIf="!isBelams">
            <svg width="18" height="18" viewBox="0 0 12 12" style="margin-left: 8px;">
                <rect x="1" y="1" width="10" height="10" stroke="currentColor" stroke-width="0.8" fill="none"/>
                <line x1="1" y1="6" x2="11" y2="6" stroke="currentColor" stroke-width="0.8"/>
                <line x1="6" y1="1" x2="6" y2="11" stroke="currentColor" stroke-width="0.8"/>
            </svg>
            <span>{{ showWireframe ? ('hide_dimensions' | translate) : ('show_dimensions' | translate) }}</span>
        </button>
        
        <!-- אפשרות מצב שקוף - מוסתרת במוצר קורות -->
        <button class="menu-option" 
                (click)="toggleTransparentMode(); isOptionsMenuOpen = false" 
                [class.active]="isTransparentMode" 
                *ngIf="!isBelams">
            <svg width="18" height="18" viewBox="0 0 12 12" style="margin-left: 8px;">
                <rect x="2" y="2" width="8" height="8" stroke="currentColor" stroke-width="0.8" fill="none"/>
                <path d="M2 2L10 10M10 2L2 10" stroke="currentColor" stroke-width="0.8"/>
            </svg>
            <span>{{ isTransparentMode ? ('hide_transparent' | translate) : ('show_transparent' | translate) }}</span>
        </button>
        
        <!-- אפשרות קוביית ניווט במובייל -->
        <button class="menu-option" 
                (click)="toggleNavigationCube(); isOptionsMenuOpen = false" 
                [class.active]="showNavigationCube">
            <svg width="18" height="18" viewBox="0 0 12 12" style="margin-left: 8px;">
                <!-- קוביה תלת-מימדית עם קווים מחברים -->
                <rect x="2" y="2" width="8" height="8" stroke="currentColor" stroke-width="0.8" fill="none"/>
                <rect x="3.5" y="3.5" width="5" height="5" stroke="currentColor" stroke-width="0.6" fill="none"/>
                <line x1="2" y1="2" x2="3.5" y2="3.5" stroke="currentColor" stroke-width="0.6"/>
                <line x1="10" y1="2" x2="8.5" y2="3.5" stroke="currentColor" stroke-width="0.6"/>
                <line x1="2" y1="10" x2="3.5" y2="8.5" stroke="currentColor" stroke-width="0.6"/>
                <line x1="10" y1="10" x2="8.5" y2="8.5" stroke="currentColor" stroke-width="0.6"/>
            </svg>
            <span>{{ showNavigationCube ? ('hide_navigation_cube' | translate) : ('show_navigation_cube' | translate) }}</span>
        </button>
        
        <!-- אפשרות איפוס מבט המצלמה -->
        <button class="menu-option" (click)="resetCameraView(); isOptionsMenuOpen = false">
            <svg width="18" height="18" viewBox="0 0 12 12" style="margin-left: 8px;">
                <!-- עין פשוטה -->
                <ellipse cx="6" cy="6" rx="4" ry="2.5" stroke="currentColor" stroke-width="0.8" fill="none"/>
                <circle cx="6" cy="6" r="1.5" fill="currentColor"/>
                <circle cx="6.5" cy="5.5" r="0.5" fill="white"/>
            </svg>
            <span>{{ 'reset_camera' | translate }}</span>
        </button>
        
        <!-- אפשרות הצגת חצים - מוסתרת במוצר קורות -->
        <button class="menu-option" 
                (click)="toggleCoordinateAxes(); isOptionsMenuOpen = false" 
                [class.active]="showCoordinateAxes" 
                *ngIf="!isBelams">
            <svg width="18" height="18" viewBox="0 0 12 12" style="margin-left: 8px; margin-top: 2px;">
                <!-- חצים תלת-מימדיים -->
                <line x1="6" y1="2" x2="6" y2="10" stroke="currentColor" stroke-width="0.8"/>
                <line x1="2" y1="6" x2="10" y2="6" stroke="currentColor" stroke-width="0.8"/>
                <line x1="4" y1="4" x2="8" y2="8" stroke="currentColor" stroke-width="0.8"/>
                <!-- חצים -->
                <polygon points="6,2 5,4 7,4" fill="currentColor"/>
                <polygon points="10,6 8,5 8,7" fill="currentColor"/>
                <polygon points="8,8 6,7 7,9" fill="currentColor"/>
            </svg>
            <span>{{ showCoordinateAxes ? ('hide_axes' | translate) : ('show_axes' | translate) }}</span>
        </button>
    </div>
    
    <!-- קוביית ניווט במובייל -->
    <div class="mobile-navigation-cube" *ngIf="showNavigationCube" [@fadeInScale]>
        <div class="nav-cube-title">בחר מבט</div>
        
        <!-- קוביה עם כפתורים -->
        <div class="mobile-base-cube">
            <!-- כפתור למעלה -->
            <button class="mobile-nav-button mobile-top-button" (click)="onNavigationClick('top')">
                <span class="nav-text">למעלה</span>
            </button>
            
            <!-- כפתור שמאל -->
            <button class="mobile-nav-button mobile-left-button" (click)="onNavigationClick('left')">
                <span class="nav-text">שמאל</span>
            </button>
            
            <!-- כפתור קדמי (מרכז) -->
            <button class="mobile-nav-button mobile-front-button" (click)="onNavigationClick('front')">
                <span class="nav-text">קדמי</span>
            </button>
            
            <!-- כפתור ימין -->
            <button class="mobile-nav-button mobile-right-button" (click)="onNavigationClick('right')">
                <span class="nav-text">ימין</span>
            </button>
            
            <!-- כפתור תחתון -->
            <button class="mobile-nav-button mobile-back-button" (click)="onNavigationClick('bottom')">
                <span class="nav-text">למטה</span>
            </button>
        </div>
        
        <button class="nav-cube-close" (click)="toggleNavigationCube()">✕</button>
    </div>
    
    <!-- התרעה על קורות מוסתרות -->
    <div class="hidden-beams-warning" *ngIf="hasHiddenBeams && !hasNoMiddleBeams">
        <svg width="12" height="12" viewBox="0 0 12 12" style="margin-left:8px;">
            <circle cx="6" cy="6" r="5" stroke="currentColor" stroke-width="0.8" fill="none"/>
            <path d="M6 3v3M6 8h.01" stroke="currentColor" stroke-width="0.8" fill="none"/>
        </svg>
        <span class="button-text">{{ 'hidden_beams_warning' | translate }}</span>
    </div>
    
    <!-- התרעה על מקרה קיצון - אין קורות באמצע -->
    <div class="hidden-beams-warning critical" *ngIf="hasNoMiddleBeams">
        <svg width="12" height="12" viewBox="0 0 12 12" style="margin-left:8px;">
            <circle cx="6" cy="6" r="5" stroke="currentColor" stroke-width="0.8" fill="none"/>
            <path d="M6 3v3M6 8h.01" stroke="currentColor" stroke-width="0.8" fill="none"/>
        </svg>
        <span class="button-text">{{ 'no_middle_beams_warning' | translate }}</span>
    </div>
    
    <div class="main-flex-row">
        <div class="controls" [class.closed]="!drawerOpen">
            <button class="drawer-toggle" (click)="toggleDrawer()">
                <svg width="12" height="12" viewBox="0 0 12 12" style="display:block;margin:auto;">
                    <polyline points="4,2 8,6 4,10" stroke="#666" stroke-width="2" fill="none"
                        [attr.transform]="drawerOpen ? 'rotate(180 6 6)' : ''" />
                </svg>
            </button>
            <ng-container *ngIf="drawerOpen">
                <!-- Spinner Loading - מוצג רק בטעינה הראשונית -->
                <div class="loading-spinner" *ngIf="isLoading && isModelLoading">
                    <div class="spinner"></div>
                </div>
                
                <!-- כל התוכן הרגיל - מוצג תמיד -->
                <div>
                <!-- כותרת מוצר -->
                <div class="product-header" *ngIf="selectedProductName" style="margin-bottom: 20px;">
                    <h3 style="margin: 0; padding: 10px; text-align: center;">
                        {{product?.translatedName || selectedProductName}}<br>
                            <span style="margin-top: 8px; font-weight: normal; font-size: 0.8em; display: block; color: #0066cc;">דגם: {{product?.model || product?.name || selectedProductName}}</span>
                    </h3>
                </div>
                
                <div *ngFor="let param of params" class="param-box">
                    
                    <!-- טיפול בשולחן - פרמטר height -->
                    <div *ngIf="isTable && param.name === 'height'">
                        <label style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <mat-form-field appearance="outline">
                            <mat-label>{{param.translatedName}}</mat-label>
                            <input matInput type="number" [(ngModel)]="param.default" 
                                   [min]="param.min" [max]="param.max" 
                        (blur)="updateModel()"
                        (keyup.enter)="updateModel()"
                        (input)="onNumberInputChange($event, 'updateModel', param)">
                        </mat-form-field>
                    </div>
                    
                    <!-- טיפול בארון - פרמטר shelfs -->
                    <div *ngIf="!isTable && param.name === 'shelfs'">
                        <label
                            style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <div class="shelf-row">
                            <div class="custom-select-wrapper">
                                <label class="custom-select-label">סוג קורה</label>
                                <div class="custom-dropdown" (click)="toggleDropdown('beam', param)" [class.open]="isDropdownOpen('beam', param)">
                                    <div class="dropdown-selected">
                                        {{param.beams[param.selectedBeamIndex]?.translatedName}}
                                        <svg class="dropdown-arrow" [class.rotated]="isDropdownOpen('beam', param)" width="16" height="16" viewBox="0 0 24 24">
                                            <polyline points="6,9 12,15 18,9" stroke="currentColor" stroke-width="2" fill="none"/>
                                        </svg>
                                    </div>
                                    <div class="dropdown-options" *ngIf="isDropdownOpen('beam', param)" (click)="$event.stopPropagation()">
                                        <div *ngFor="let beam of param.beams; let bIdx = index" 
                                             class="dropdown-option" 
                                             [class.selected]="bIdx === param.selectedBeamIndex"
                                             (click)="selectBeam(bIdx, param)">
                                            {{beam.translatedName}}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="custom-select-wrapper">
                                <label class="custom-select-label">סוג עץ</label>
                                <div class="custom-dropdown" (click)="toggleDropdown('type', param)" [class.open]="isDropdownOpen('type', param)">
                                    <div class="dropdown-selected">
                                        {{param.beams[param.selectedBeamIndex]?.types[param.selectedTypeIndex]?.translatedName}}
                                        <svg class="dropdown-arrow" [class.rotated]="isDropdownOpen('type', param)" width="16" height="16" viewBox="0 0 24 24">
                                            <polyline points="6,9 12,15 18,9" stroke="currentColor" stroke-width="2" fill="none"/>
                                        </svg>
                                    </div>
                                    <div class="dropdown-options" *ngIf="isDropdownOpen('type', param)" (click)="$event.stopPropagation()">
                                        <div *ngFor="let type of param.beams[param.selectedBeamIndex]?.types; let tIdx = index" 
                                             class="dropdown-option" 
                                             [class.selected]="tIdx === param.selectedTypeIndex"
                                             (click)="selectType(tIdx, param)">
                                            {{type.translatedName}}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="add-shelf-btn-container">
                            <button class="add-shelf-btn" (click)="param.default.push(param.min); updateBeams()">
                                <svg viewBox="0 0 16 16" width="14" height="14">
                                    <circle cx="8" cy="8" r="7" fill="#fff" />
                                    <line x1="8" y1="4" x2="8" y2="12" stroke="#333" stroke-width="2" />
                                    <line x1="4" y1="8" x2="12" y2="8" stroke="#333" stroke-width="2" />
                                </svg>
                            </button>
                        </div>
                        <div class="shelf-measurements-container beam-array-container">
                            <div *ngFor="let i of [].constructor(param.default.length); let idx = index" 
                                class="shelf-row" 
                                [class.shelf-row-with-amount]="param.setAmount === true">
                                <div class="shelf-gap-field-wrapper">
                                    <mat-form-field appearance="outline" class="shelf-gap-field">
                                        <mat-label>מידה {{param.default.length - idx}} - {{getUnitForParameter(param)}}</mat-label>
                                        <input matInput type="number" [min]="param.min" [max]="param.max" [step]="1"
                                            [(ngModel)]="param.default[param.default.length - 1 - idx]"
                                            (blur)="updateShelfParameterValue(param, param.default[param.default.length - 1 - idx], param.default.length - 1 - idx)"
                  (keyup.enter)="updateShelfParameterValue(param, param.default[param.default.length - 1 - idx], param.default.length - 1 - idx)"
                  (input)="onShelfInputChange($event, param, idx)">
                                    </mat-form-field>
                                    <button *ngIf="idx !== param.default.length - 1" class="remove-shelf-btn" 
                                        [class.remove-shelf-btn-with-amount]="param.setAmount === true"
                                        (click)="param.default.splice(param.default.length - 1 - idx,1); updateBeams()"
                                        [disabled]="param.default.length<=1" aria-label="הסר מדף">
                                        <svg width="14" height="14" viewBox="0 0 14 14">
                                            <circle cx="7" cy="7" r="6" fill="#fff" stroke="#d32f2f" stroke-width="1.2" />
                                            <line x1="4.5" y1="4.5" x2="9.5" y2="9.5" stroke="#d32f2f" stroke-width="1.5" />
                                            <line x1="9.5" y1="4.5" x2="4.5" y2="9.5" stroke="#d32f2f" stroke-width="1.5" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
            
                        </div>
                    </div>
                    
                    <!-- טיפול במוצר קורות לפי מידה - פרמטר beams עם setAmount (בדיוק כמו קורות מדף של השולחן) -->
                    <div *ngIf="isBelams && param.name === 'beams' && param.setAmount">
                        <label style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <div class="shelf-row">
                            <div class="custom-select-wrapper">
                                <label class="custom-select-label">סוג קורה</label>
                                <div class="custom-dropdown" (click)="toggleDropdown('beam', param)" [class.open]="isDropdownOpen('beam', param)">
                                    <div class="dropdown-selected">
                                        {{param.beams[param.selectedBeamIndex]?.translatedName}}
                                        <svg class="dropdown-arrow" [class.rotated]="isDropdownOpen('beam', param)" width="16" height="16" viewBox="0 0 24 24">
                                            <polyline points="6,9 12,15 18,9" stroke="currentColor" stroke-width="2" fill="none"/>
                                        </svg>
                                    </div>
                                    <div class="dropdown-options" *ngIf="isDropdownOpen('beam', param)" (click)="$event.stopPropagation()">
                                        <div *ngFor="let beam of param.beams; let bIdx = index" 
                                             class="dropdown-option" 
                                             [class.selected]="bIdx === param.selectedBeamIndex"
                                             (click)="selectBeam(bIdx, param)">
                                            {{beam.translatedName}}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="custom-select-wrapper">
                                <label class="custom-select-label">סוג עץ</label>
                                <div class="custom-dropdown" (click)="toggleDropdown('type', param)" [class.open]="isDropdownOpen('type', param)">
                                    <div class="dropdown-selected">
                                        {{param.beams[param.selectedBeamIndex || 0]?.types[param.selectedTypeIndex]?.translatedName}}
                                        <svg class="dropdown-arrow" [class.rotated]="isDropdownOpen('type', param)" width="16" height="16" viewBox="0 0 24 24">
                                            <polyline points="6,9 12,15 18,9" stroke="currentColor" stroke-width="2" fill="none"/>
                                        </svg>
                                    </div>
                                    <div class="dropdown-options" *ngIf="isDropdownOpen('type', param)" (click)="$event.stopPropagation()">
                                        <div *ngFor="let type of param.beams[param.selectedBeamIndex || 0]?.types || []; let tIdx = index" 
                                             class="dropdown-option" 
                                             [class.selected]="tIdx === param.selectedTypeIndex"
                                             (click)="selectType(tIdx, param)">
                                            {{type.translatedName}}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="add-shelf-btn-container">
                            <button class="add-shelf-btn" (click)="addBeamWithAmount(param); updateBeams()">
                                <svg viewBox="0 0 16 16" width="14" height="14">
                                    <circle cx="8" cy="8" r="7" fill="#fff" />
                                    <line x1="8" y1="4" x2="8" y2="12" stroke="#333" stroke-width="2" />
                                    <line x1="4" y1="8" x2="12" y2="8" stroke="#333" stroke-width="2" />
                                </svg>
                            </button>
                        </div>
                        <div class="shelf-measurements-container beam-array-container">
                            <div *ngFor="let i of [].constructor(param.default.length); let idx = index" 
                                class="shelf-row" 
                                [class.shelf-row-with-amount]="param.setAmount === true">
                                <div class="shelf-gap-field-wrapper">
                                    <div class="beam-entry-container">
                                        <mat-form-field appearance="outline" class="shelf-gap-field-length">
                                            <mat-label>אורך {{param.default.length - idx}}</mat-label>
                                            <input matInput type="number" [min]="param.min" [max]="param.max" [step]="1"
                                                [(ngModel)]="param.default[param.default.length - 1 - idx].length"
                                                (blur)="updateShelfParameterValue(param, param.default[param.default.length - 1 - idx], param.default.length - 1 - idx)"
                                                (keyup.enter)="updateShelfParameterValue(param, param.default[param.default.length - 1 - idx], param.default.length - 1 - idx)"
                                                (input)="onShelfInputChange($event, param, idx)">
                                        </mat-form-field>
                                        <div class="quantity-container">
                                            <div class="quantity-label-above">כמות</div>
                                            <div class="quantity-control">
                                                <!-- במובייל: פלוס למעלה -->
                                                <button class="quantity-btn plus"
                                                        (click)="increaseAmount(param, idx)">
                                                    <svg width="12" height="12" viewBox="0 0 12 12">
                                                        <line x1="6" y1="4" x2="6" y2="8" stroke="currentColor" stroke-width="1.5"/>
                                                        <line x1="4" y1="6" x2="8" y2="6" stroke="currentColor" stroke-width="1.5"/>
                                                    </svg>
                                                </button>
                                                 <!-- באמצע: ערך הזנה -->
                                                 <input class="quantity-input"
                                                        type="number" 
                                                        [(ngModel)]="param.default[param.default.length - 1 - idx].amount"
                                                        (change)="updateShelfParameterValue(param, param.default[param.default.length - 1 - idx], param.default.length - 1 - idx)"
                                                        (keyup.enter)="updateShelfParameterValue(param, param.default[param.default.length - 1 - idx], param.default.length - 1 - idx)"
                                                        (input)="onShelfInputChange($event, param, idx)"
                                                        min="1">
                                                <!-- למטה: מינוס -->
                                                <button class="quantity-btn minus" 
                                                        (click)="decreaseAmount(param, idx)">
                                                    <svg width="12" height="12" viewBox="0 0 12 12">
                                                        <line x1="4" y1="6" x2="8" y2="6" stroke="currentColor" stroke-width="1.5"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <button *ngIf="idx !== param.default.length - 1" class="remove-shelf-btn"
                                        [class.remove-shelf-btn-with-amount]="param.setAmount === true"
                                        (click)="param.default.splice(param.default.length - 1 - idx,1); updateBeams()"
                                        [disabled]="param.default.length<=1" aria-label="הסר קורה">
                                        <svg width="14" height="14" viewBox="0 0 14 14">
                                            <circle cx="7" cy="7" r="6" fill="#fff" stroke="#d32f2f" stroke-width="1.2" />
                                            <line x1="4.5" y1="4.5" x2="9.5" y2="9.5" stroke="#d32f2f" stroke-width="1.5" />
                                            <line x1="9.5" y1="4.5" x2="4.5" y2="9.5" stroke="#d32f2f" stroke-width="1.5" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- טיפול בשולחן - פרמטר plata -->
                    <div *ngIf="isTable && param.name === 'plata'">
                        <label style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <div class="shelf-row">
                            <div class="custom-select-wrapper">
                                <label class="custom-select-label">סוג קורה</label>
                                <div class="custom-dropdown" (click)="toggleDropdown('beam', param)" [class.open]="isDropdownOpen('beam', param)">
                                    <div class="dropdown-selected">
                                        {{param.beams[param.selectedBeamIndex]?.translatedName}}
                                        <svg class="dropdown-arrow" [class.rotated]="isDropdownOpen('beam', param)" width="16" height="16" viewBox="0 0 24 24">
                                            <polyline points="6,9 12,15 18,9" stroke="currentColor" stroke-width="2" fill="none"/>
                                        </svg>
                                    </div>
                                    <div class="dropdown-options" *ngIf="isDropdownOpen('beam', param)" (click)="$event.stopPropagation()">
                                        <div *ngFor="let beam of param.beams; let bIdx = index" 
                                             class="dropdown-option" 
                                             [class.selected]="bIdx === param.selectedBeamIndex"
                                             (click)="selectBeam(bIdx, param)">
                                            {{beam.translatedName}}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="custom-select-wrapper">
                                <label class="custom-select-label">סוג עץ</label>
                                <div class="custom-dropdown" (click)="toggleDropdown('type', param)" [class.open]="isDropdownOpen('type', param)">
                                    <div class="dropdown-selected">
                                        {{param.beams[param.selectedBeamIndex || 0]?.types[param.selectedTypeIndex]?.translatedName}}
                                        <svg class="dropdown-arrow" [class.rotated]="isDropdownOpen('type', param)" width="16" height="16" viewBox="0 0 24 24">
                                            <polyline points="6,9 12,15 18,9" stroke="currentColor" stroke-width="2" fill="none"/>
                                        </svg>
                                    </div>
                                    <div class="dropdown-options" *ngIf="isDropdownOpen('type', param)" (click)="$event.stopPropagation()">
                                        <div *ngFor="let type of param.beams[param.selectedBeamIndex || 0]?.types || []; let tIdx = index" 
                                             class="dropdown-option" 
                                             [class.selected]="tIdx === param.selectedTypeIndex"
                                             (click)="selectType(tIdx, param)">
                                            {{type.translatedName}}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div *ngIf="param.type === 'beamSingle' && (!isTable || param.name !== 'plata')">
                        <label
                            style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <div class="custom-select-wrapper">
                            <label class="custom-select-label">סוג קורה</label>
                            <div class="custom-dropdown" (click)="toggleDropdown('beam', param)" [class.open]="isDropdownOpen('beam', param)">
                                <div class="dropdown-selected">
                                    {{param.beams[param.selectedBeamIndex]?.translatedName}}
                                    <svg class="dropdown-arrow" [class.rotated]="isDropdownOpen('beam', param)" width="16" height="16" viewBox="0 0 24 24">
                                        <polyline points="6,9 12,15 18,9" stroke="currentColor" stroke-width="2" fill="none"/>
                                    </svg>
                                </div>
                                <div class="dropdown-options" *ngIf="isDropdownOpen('beam', param)" (click)="$event.stopPropagation()">
                                    <div *ngFor="let beam of param.beams; let bIdx = index" 
                                         class="dropdown-option" 
                                         [class.selected]="bIdx === param.selectedBeamIndex"
                                         (click)="selectBeam(bIdx, param)">
                                        {{beam.translatedName}}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="custom-select-wrapper">
                            <label class="custom-select-label">סוג עץ</label>
                            <div class="custom-dropdown" (click)="toggleDropdown('type', param)" [class.open]="isDropdownOpen('type', param)">
                                <div class="dropdown-selected">
                                    {{param.beams[param.selectedBeamIndex]?.types[param.selectedTypeIndex]?.translatedName}}
                                    <svg class="dropdown-arrow" [class.rotated]="isDropdownOpen('type', param)" width="16" height="16" viewBox="0 0 24 24">
                                        <polyline points="6,9 12,15 18,9" stroke="currentColor" stroke-width="2" fill="none"/>
                                    </svg>
                                </div>
                                <div class="dropdown-options" *ngIf="isDropdownOpen('type', param)" (click)="$event.stopPropagation()">
                                    <div *ngFor="let type of param.beams[param.selectedBeamIndex]?.types; let tIdx = index" 
                                         class="dropdown-option" 
                                         [class.selected]="tIdx === param.selectedTypeIndex"
                                         (click)="selectType(tIdx, param)">
                                        {{type.translatedName}}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- פרמטר extraBeam מיוחד עבור שולחן -->
                    <div *ngIf="isTable && param.name === 'extraBeam'">
                        <label style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <div class="param-box non-beam">
                            <mat-form-field appearance="outline">
                                <mat-label>{{param.translatedName}} - {{getUnitForParameter(param)}}</mat-label>
                                <input matInput type="number" [min]="param.min" [max]="param.max"
                                    [step]="getStep(param.type)" [(ngModel)]="param.default" 
                                    (blur)="updateParameterValue(param, param.default)"
                                    (keyup.enter)="updateParameterValue(param, param.default)"
          (input)="onParameterInputChange($event, param)">
                            </mat-form-field>
                        </div>
                    </div>
                    
                    <!-- פרמטר boolean (toggle) -->
                    <div *ngIf="param.type === 'boolian' && (param.name !== 'openCover' || getParam('isCover')?.default === true)" class="boolean-param">
                        <span class="boolean-label">{{param.translatedName}}</span>
                        <mat-slide-toggle 
                            [(ngModel)]="param.default"
                            (change)="updateBeams()"
                            color="primary">
                        </mat-slide-toggle>
                    </div>
                    
                    
                    <div *ngIf="param.type !== 'beamSingle' && param.type !== 'boolian' && param.name !== 'shelfs' && !(isTable && param.name === 'height') && !(isTable && param.name === 'extraBeam')">
                        <label
                            style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <div class="param-box non-beam">
                            <mat-form-field appearance="outline">
                                <mat-label>{{param.translatedName}} - {{getUnitForParameter(param)}}</mat-label>
                                <input matInput type="number" [min]="param.min" [max]="param.max"
                                    [step]="getStep(param.type)" [(ngModel)]="param.default" 
                                    (blur)="updateParameterValue(param, param.default)"
                                    (keyup.enter)="updateParameterValue(param, param.default)"
          (input)="onParameterInputChange($event, param)">
                            </mat-form-field>
                        </div>
                    </div>
                </div>
                
                <!-- שדה כמות יחידות -->
                <div class="quantity-selector">
                    <label class="quantity-label">כמות יחידות:</label>
                    <div class="quantity-control">
                        <button class="quantity-btn minus" (click)="decreaseQuantity()" [disabled]="quantity <= 1">
                            <svg width="12" height="12" viewBox="0 0 12 12">
                                <line x1="3" y1="6" x2="9" y2="6" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </button>
                        <input 
                            type="number" 
                            class="quantity-input" 
                            [(ngModel)]="quantity" 
                            (change)="onQuantityChange($event)"
                            min="1">
                        <button class="quantity-btn plus" (click)="increaseQuantity()">
                            <svg width="12" height="12" viewBox="0 0 12 12">
                                <line x1="6" y1="3" x2="6" y2="9" stroke="currentColor" stroke-width="2"/>
                                <line x1="3" y1="6" x2="9" y2="6" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- טבלת מידות המוצר - מוסתר למוצר beams -->
                <div class="product-dimensions-container" *ngIf="!isLoading && !isBelams">
                    <h3>מידות המוצר הסופי</h3>
                    <table class="dimensions-table">
                        <!-- מידות כוללות - לכל המוצרים -->
                        <tr>
                            <td>אורך כולל:</td>
                            <td [innerHTML]="getProductDimensions().length"></td>
                        </tr>
                        <tr>
                            <td>רוחב כולל:</td>
                            <td [innerHTML]="getProductDimensions().width"></td>
                        </tr>
                        <tr>
                            <td>גובה כולל:</td>
                            <td [innerHTML]="getProductDimensions().height"></td>
                        </tr>
                        
                        <!-- מידות ספציפיות - רק לארון, שולחן ומיטה -->
                        <tr *ngIf="!isPlanter && !isBox">
                            <td>{{ (isTable || isFuton) ? 'כמות קורות בפלטה:' : 'כמות קורות במדף:' }}</td>
                            <td [innerHTML]="getProductDimensions().beamCount"></td>
                        </tr>
                        <tr *ngIf="!isPlanter && !isBox">
                            <td>{{ (isTable || isFuton) ? 'רווח בין קורות הפלטה:' : 'רווח בין קורות המדף:' }}</td>
                            <td [innerHTML]="getProductDimensions().gapBetweenBeams"></td>
                        </tr>
                        
                        <!-- כמות מדפים - רק לארון -->
                        <tr *ngIf="!isTable && !isFuton && !isPlanter && !isBox">
                            <td>כמות מדפים:</td>
                            <td [innerHTML]="getProductDimensions().shelfCount"></td>
                        </tr>
                    </table>
                </div>
                
                <!-- אלמנט ריק להבטחת גלילה מלאה -->
                <div class="scroll-spacer"></div>
                </div> <!-- סיום התוכן הרגיל -->
            </ng-container>
        </div>
        <div #rendererContainer class="renderer-container" [class.expanded]="!drawerOpen">
            <!-- Spinner במרכז התצוגה התלת-מימדית -->
            <div class="model-loading-spinner" *ngIf="isModelLoading">
                <div class="spinner"></div>
            </div>
            
            <!-- כפתור ניווט -->
            <div class="navigation-button">
                <!-- קוביה הבסיס -->
                <div class="base-cube">
                    <!-- כפתור TOP -->
                    <div class="nav-button top-button" 
                         (click)="onNavigationClick('top')"
                         [matTooltip]="'view_top' | translate"
                         matTooltipPosition="above"></div>
                    
                    <!-- כפתור BOTTOM -->
                    <div class="nav-button bottom-button" 
                         (click)="onNavigationClick('bottom')"
                         [matTooltip]="'view_bottom' | translate"
                         matTooltipPosition="above"></div>
                    
                    <!-- כפתור LEFT -->
                    <div class="nav-button left-button" 
                         (click)="onNavigationClick('left')"
                         [matTooltip]="'view_left' | translate"
                         matTooltipPosition="above"></div>
                    
                    <!-- כפתור RIGHT -->
                    <div class="nav-button right-button" 
                         (click)="onNavigationClick('right')"
                         [matTooltip]="'view_right' | translate"
                         matTooltipPosition="above"></div>
                    
                    <!-- כפתור FRONT -->
                    <div class="nav-button front-button" 
                         (click)="onNavigationClick('front')"
                         [matTooltip]="'view_front' | translate"
                         matTooltipPosition="above"></div>
                </div>
            </div>
        </div>
    </div>
    
    
    <!-- אזור חישוב המחיר -->
    <div class="price-calculation-area" [class.minimized]="isPriceMinimized">
        <!-- כפתור צמצום/הרחב -->
        <button class="minimize-btn" mat-icon-button 
                [matTooltip]="isPriceMinimized ? 'הרחב' : 'צמצם'"
                matTooltipPosition="above"
                (click)="togglePriceMinimize()"
                [class.expanded-mode]="isPriceMinimized"
                aria-label="צמצם/הרחב">
            <mat-icon>{{ isPriceMinimized ? 'unfold_more' : 'close' }}</mat-icon>
        </button>
        
        <button class="fullscreen-btn" mat-icon-button color="primary" 
                [matTooltip]="!isPriceManuOpen ? ('price-calculation.tooltip' | translate) : ''" 
                matTooltipPosition="above"
                (click)="togglePriceMenu()"
                *ngIf="!isPriceMinimized"
                aria-label="מסך מלא">
            <mat-icon>fullscreen</mat-icon>
        </button>
        <div class="price-info">
            <div class="price-display-wrapper">
                <!-- כפתור בחירת אופציה -->
                <button class="pricing-option-button" 
                        [matMenuTriggerFor]="pricingOptionsMenu"
                        *ngIf="calculatedPrice > 0 && !isPriceMinimized">
                    <div class="option-name-small">
                        {{ getPricingOptionName() }}
                        <svg class="edit-icon" width="12" height="12" viewBox="0 0 12 12">
                            <path d="M 8.5 1 L 11 3.5 L 4 10.5 L 1 11 L 1.5 8 Z" 
                                  stroke="#0066cc" 
                                  stroke-width="1" 
                                  fill="none" 
                                  stroke-linejoin="round"/>
                            <line x1="7.5" y1="2" x2="10" y2="4.5" stroke="#0066cc" stroke-width="0.8"/>
                        </svg>
                    </div>
                    
                    <!-- קפסולות פירוט מחיר -->
                    <div class="price-capsules">
                        <div class="price-capsule">
                            <div class="capsule-label">שרטוט</div>
                            <div class="capsule-value"><span class="currency-symbol">₪</span>{{ drawingPrice }}</div>
                        </div>
                        <div class="price-capsule" *ngIf="selectedPricingOption === 'cut' || selectedPricingOption === 'full'">
                            <div class="capsule-label">קורות</div>
                            <div class="capsule-value"><span class="currency-symbol">₪</span>{{ getBeamsOnlyPrice() }}</div>
                        </div>
                        <div class="price-capsule" *ngIf="selectedPricingOption === 'cut'">
                            <div class="capsule-label">חיתוך</div>
                            <div class="capsule-value"><span class="currency-symbol">₪</span>{{ getCuttingPrice() }}</div>
                        </div>
                    </div>
                    
                    <div class="price-display">
                        <!-- קונטיינר פנימי למחיר בלבד -->
                        <div class="price-only-wrapper">
                            <span class="price-label">מחיר:</span>
                            <div class="price-value-inline">
                                {{ getFinalPrice() }} ₪
                            </div>
                        </div>
                        
                        <!-- כפתור המשך -->
                        <button class="continue-button" 
                                (click)="onContinueOrder(); $event.stopPropagation()"
                                *ngIf="calculatedPrice > 0"
                                [@fadeInScale]>
                            <span class="continue-text">המשך</span>
                            <svg class="continue-arrow" width="14" height="14" viewBox="0 0 14 14">
                                <path d="M 2 7 L 10 7 M 7 3 L 11 7 L 7 11" stroke="currentColor" stroke-width="1.8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </button>
                
                <!-- תצוגת טעינה -->
                <div class="price-loader" *ngIf="calculatedPrice === 0">
                    <mat-spinner diameter="20"></mat-spinner>
                    <span class="calculating-text">מחשב מחיר...</span>
                </div>
                
                <!-- כפתור המשך מצומצם -->
                <button class="minimized-continue-button" 
                        (click)="togglePriceMinimize()"
                        *ngIf="isPriceMinimized && calculatedPrice > 0"
                        [@fadeInScale]>
                    <span class="minimized-text">המשך</span>
                    <span class="minimized-price">({{ getFinalPrice() }}₪)</span>
                    <svg class="minimized-arrow" width="14" height="14" viewBox="0 0 14 14">
                        <path d="M 2 7 L 10 7 M 7 3 L 11 7 L 7 11" stroke="currentColor" stroke-width="1.8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- תפריט אופציות תמחור -->
        <mat-menu #pricingOptionsMenu="matMenu" class="pricing-options-menu" [hasBackdrop]="false">
            <!-- כותרת התפריט -->
            <div class="pricing-menu-header">
                <svg width="22" height="22" viewBox="0 0 22 22" class="header-icon">
                    <!-- בועת דיבור -->
                    <path d="M 3 4 Q 3 3 4 3 L 18 3 Q 19 3 19 4 L 19 13 Q 19 14 18 14 L 8 14 L 5 17 L 5 14 L 4 14 Q 3 14 3 13 Z" 
                          stroke="#0066cc" 
                          stroke-width="1.2" 
                          fill="none"/>
                    <!-- סימני שאלה/אפשרויות -->
                    <text x="7" y="10" font-size="8" fill="#0066cc" font-weight="600">?</text>
                    <circle cx="11" cy="8.5" r="0.8" fill="#0066cc"/>
                    <circle cx="14" cy="8.5" r="0.8" fill="#0066cc"/>
                </svg>
                <div class="header-text">
                    <div class="header-title">בחרו אופציית הזמנה</div>
                    <div class="header-subtitle">קורות חתוכות, שלמות, או רק שרטוטים?</div>
                </div>
            </div>
            
            <!-- אופציה 1: קורות חתוכות -->
            <button mat-menu-item (click)="selectPricingOption('cut')" [class.selected]="selectedPricingOption === 'cut'">
                <div class="pricing-menu-item">
                    <div class="option-title-row">
                        <svg width="16" height="16" viewBox="0 0 16 16" class="check-icon" *ngIf="selectedPricingOption === 'cut'">
                            <!-- מסגרת checkbox -->
                            <rect x="1" y="1" width="14" height="14" rx="3" stroke="#0066cc" stroke-width="1.2" fill="none"/>
                            <!-- סימן V בכתב יד -->
                            <path class="check-path" d="M 4 8 L 7 11 L 12 5" stroke="#0066cc" stroke-width="1.8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <div class="option-title">קורות חתוכות לפי מידה</div>
                    </div>
                    <div class="menu-capsules">
                        <div class="menu-capsule">
                            <div class="menu-capsule-label">שרטוט</div>
                            <div class="menu-capsule-value">₪{{ drawingPrice }}</div>
                        </div>
                        <div class="menu-capsule">
                            <div class="menu-capsule-label">קורות</div>
                            <div class="menu-capsule-value">₪{{ getBeamsOnlyPrice() }}</div>
                        </div>
                        <div class="menu-capsule">
                            <div class="menu-capsule-label">חיתוך</div>
                            <div class="menu-capsule-value">₪{{ getCuttingPrice() }}</div>
                        </div>
                    </div>
                    <div class="option-total">סה"כ: {{ getBeamsOnlyPrice() + getCuttingPrice() + drawingPrice }}₪</div>
                </div>
            </button>
            
            <!-- אופציה 2: קורות שלמות + הוראות -->
            <button mat-menu-item (click)="selectPricingOption('full')" [class.selected]="selectedPricingOption === 'full'">
                <div class="pricing-menu-item">
                    <div class="option-title-row">
                        <svg width="16" height="16" viewBox="0 0 16 16" class="check-icon" *ngIf="selectedPricingOption === 'full'">
                            <!-- מסגרת checkbox -->
                            <rect x="1" y="1" width="14" height="14" rx="3" stroke="#0066cc" stroke-width="1.2" fill="none"/>
                            <!-- סימן V בכתב יד -->
                            <path class="check-path" d="M 4 8 L 7 11 L 12 5" stroke="#0066cc" stroke-width="1.8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <div class="option-title">קורות שלמות והוראות חיתוך</div>
                    </div>
                    <div class="menu-capsules">
                        <div class="menu-capsule">
                            <div class="menu-capsule-label">שרטוט</div>
                            <div class="menu-capsule-value">₪{{ drawingPrice }}</div>
                        </div>
                        <div class="menu-capsule">
                            <div class="menu-capsule-label">קורות</div>
                            <div class="menu-capsule-value">₪{{ getBeamsOnlyPrice() }}</div>
                        </div>
                    </div>
                    <div class="option-total">סה"כ: {{ getBeamsOnlyPrice() + drawingPrice }}₪</div>
                </div>
            </button>
            
            <!-- אופציה 3: הוראות בלבד -->
            <button mat-menu-item (click)="selectPricingOption('plan')" [class.selected]="selectedPricingOption === 'plan'">
                <div class="pricing-menu-item">
                    <div class="option-title-row">
                        <svg width="16" height="16" viewBox="0 0 16 16" class="check-icon" *ngIf="selectedPricingOption === 'plan'">
                            <!-- מסגרת checkbox -->
                            <rect x="1" y="1" width="14" height="14" rx="3" stroke="#0066cc" stroke-width="1.2" fill="none"/>
                            <!-- סימן V בכתב יד -->
                            <path class="check-path" d="M 4 8 L 7 11 L 12 5" stroke="#0066cc" stroke-width="1.8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <div class="option-title">הוראות חיתוך בלבד</div>
                    </div>
                    <div class="menu-capsules">
                        <div class="menu-capsule">
                            <div class="menu-capsule-label">שרטוט</div>
                            <div class="menu-capsule-value">₪{{ drawingPrice }}</div>
                        </div>
                    </div>
                    <div class="option-total">סה"כ: {{ drawingPrice }}₪</div>
                </div>
            </button>
        </mat-menu>
        
        <!-- קופסא נוספת שמופיעה כשהתפריט פתוח -->
        <div class="price-menu-box" 
             [class.with-warning]="hasHiddenBeams || hasNoMiddleBeams"
             *ngIf="isPriceManuOpen">
            <!-- כותרת דינמית -->
            <span class="thinking-text" *ngIf="!BeamsDataForPricing || BeamsDataForPricing.length === 0">{{ 'price-calculation.first-title' | translate }}...</span>
            <span class="main-title" *ngIf="BeamsDataForPricing && BeamsDataForPricing.length > 0">חומרי גלם:</span>
            
            <!-- סיכום קורות -->
            <div class="materials-summary" *ngIf="BeamsDataForPricing && BeamsDataForPricing.length > 0">
                <div class="sub-title">קורות:</div>
                <div *ngFor="let beamData of BeamsDataForPricing" class="beam-name">
                    <!-- כותרת סוג הקורה -->
                    <div class="pricing-title">{{ beamData.beamTranslatedName || beamData.beamName }} ({{ beamData.type.translatedName }})</div>
                    
                    <!-- רשימת המידות -->
                    <div *ngFor="let sizeData of beamData.totalSizes" class="size-item">
                        <span class="size-value">{{ sizeData.length }} ס"מ</span>
                        <span class="size-separator"></span>
                        <span class="size-count">{{ sizeData.count }} {{ 'price-calculation.units' | translate }}</span>
                    </div>
                </div>
            </div>
            
            <!-- סיכום ברגים -->
            <div class="materials-summary" *ngIf="ForgingDataForPricing && ForgingDataForPricing.length > 0">
                <div class="sub-title">ברגים:</div>
                <div class="beam-type-section">
                    <div *ngFor="let forgingData of ForgingDataForPricing" class="size-item">
                        <span class="size-value">{{ forgingData.length }} ס"מ</span>
                        <span class="size-separator"></span>
                        <span class="size-count">{{ forgingData.count }} {{ 'price-calculation.units' | translate }}</span>
                    </div>
                </div>
            </div>
            
            <!-- תוכנית חיתוך קורות -->
            <div class="materials-summary" *ngIf="cuttingPlan && cuttingPlan.length > 0">
                <div class="main-title">תוכנית חיתוך קורות:</div>
                <div *ngFor="let beam of cuttingPlan" class="beam-type-section">
                    <!-- כותרת קורה -->
                    <div class="beam-header">
                        <div class="beam-number">{{ beam.beamNumber }}</div>
                        <div class="beam-details-item">
                            <span class="beam-text">{{ beam.beamType }} ({{ beam.beamWoodType }}) {{ beam.beamLength }} ס"מ</span>
                            <span class="beam-separator" style="opacity: 0;"></span>
                            <span class="beam-price">{{ beam.beamPrice }}₪</span>
                        </div>
                    </div>
                    
                    <!-- רשימת החתיכות מקובצות לפי גודל -->
                    <div *ngFor="let cutGroup of getCutGroups(beam.cuts)" class="size-item">
                        <span class="size-value">{{ cutGroup.length }} ס"מ</span>
                        <span class="size-separator"></span>
                        <span class="size-count">{{ cutGroup.count }} {{ 'price-calculation.units' | translate }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>