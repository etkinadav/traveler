<div class="threejs-box-wrapper">
    <!-- הודעת validation הוסרה - משתמשים ב-SnackBar -->
    
    <!-- כפתור להצגת wireframe - מחוץ לתפריט -->
    <button class="wireframe-toggle" (click)="toggleWireframe()" 
            [class.active]="showWireframe" 
            matTooltip="הצג את מידות המוצר המלאות"
            matTooltipPosition="below">
        <svg width="12" height="12" viewBox="0 0 12 12" style="margin-left:8px;">
            <rect x="1" y="1" width="10" height="10" stroke="currentColor" stroke-width="0.8" fill="none"/>
            <line x1="1" y1="6" x2="11" y2="6" stroke="currentColor" stroke-width="0.8"/>
            <line x1="6" y1="1" x2="6" y2="11" stroke="currentColor" stroke-width="0.8"/>
        </svg>
        <span class="button-text">{{ 'show_dimensions' | translate }}</span>
    </button>
    
    <!-- התרעה על קורות מוסתרות -->
    <div class="hidden-beams-warning" *ngIf="hasHiddenBeams && !hasNoMiddleBeams">
        <svg width="12" height="12" viewBox="0 0 12 12" style="margin-left:8px;">
            <circle cx="6" cy="6" r="5" stroke="currentColor" stroke-width="0.8" fill="none"/>
            <path d="M6 3v3M6 8h.01" stroke="currentColor" stroke-width="0.8" fill="none"/>
        </svg>
        <span class="button-text">{{ 'hidden_beams_warning' | translate }}</span>
    </div>
    
    <!-- התרעה על מקרה קיצון - אין קורות באמצע -->
    <div class="hidden-beams-warning critical" *ngIf="hasNoMiddleBeams">
        <svg width="12" height="12" viewBox="0 0 12 12" style="margin-left:8px;">
            <circle cx="6" cy="6" r="5" stroke="currentColor" stroke-width="0.8" fill="none"/>
            <path d="M6 3v3M6 8h.01" stroke="currentColor" stroke-width="0.8" fill="none"/>
        </svg>
        <span class="button-text">{{ 'no_middle_beams_warning' | translate }}</span>
    </div>
    
    <div class="main-flex-row">
        <div class="controls" [class.closed]="!drawerOpen">
            <button class="drawer-toggle" (click)="toggleDrawer()">
                <svg width="12" height="12" viewBox="0 0 12 12" style="display:block;margin:auto;">
                    <polyline points="4,2 8,6 4,10" stroke="#666" stroke-width="2" fill="none"
                        [attr.transform]="drawerOpen ? 'rotate(180 6 6)' : ''" />
                </svg>
            </button>
            <ng-container *ngIf="drawerOpen">
                <!-- כותרת מוצר -->
                <div class="product-header" *ngIf="selectedProductName" style="margin-bottom: 20px;">
                    <h3 style="margin: 0; padding: 10px; text-align: center;">
                        {{product?.translatedName || selectedProductName}}<br>
                        <span style="margin-top: 8px; font-weight: normal; font-size: 0.8em; display: block;">דגם: {{product?.name || selectedProductName}}</span>
                    </h3>
                </div>
                
                <div *ngFor="let param of params" class="param-box">
                    
                    <!-- טיפול בשולחן - פרמטר height -->
                    <div *ngIf="isTable && param.name === 'height'">
                        <label style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <mat-form-field appearance="outline">
                            <mat-label>{{param.translatedName}}</mat-label>
                            <input matInput type="number" [(ngModel)]="param.default" 
                                   [min]="param.min" [max]="param.max" 
                                   (blur)="updateModel()"
                                   (keyup.enter)="updateModel()">
                        </mat-form-field>
                    </div>
                    
                    <!-- טיפול בארון - פרמטר shelfs -->
                    <div *ngIf="!isTable && param.name === 'shelfs'">
                        <label
                            style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <div class="shelf-row">
                            <mat-form-field appearance="outline">
                                <mat-label>סוג קורה</mat-label>
                                <mat-select [(ngModel)]="param.selectedBeamIndex" (selectionChange)="updateBeams()">
                                    <mat-option *ngFor="let beam of param.beams; let bIdx = index" [value]="bIdx">
                                        {{beam.translatedName}}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline">
                                <mat-label>סוג עץ</mat-label>
                                <mat-select [(ngModel)]="param.selectedTypeIndex" (selectionChange)="updateBeams()">
                                    <mat-option
                                        *ngFor="let type of param.beams[param.selectedBeamIndex]?.types; let tIdx = index"
                                        [value]="tIdx">
                                        {{type.translatedName}}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="add-shelf-btn-container">
                            <button class="add-shelf-btn" (click)="param.default.push(param.min); updateBeams()">
                                <svg viewBox="0 0 16 16" width="14" height="14">
                                    <circle cx="8" cy="8" r="7" fill="#fff" />
                                    <line x1="8" y1="4" x2="8" y2="12" stroke="#333" stroke-width="2" />
                                    <line x1="4" y1="8" x2="12" y2="8" stroke="#333" stroke-width="2" />
                                </svg>
                            </button>
                        </div>
                        <div class="shelf-measurements-container beam-array-container">
                            <div *ngFor="let i of [].constructor(param.default.length); let idx = index" class="shelf-row">
                                <div class="shelf-gap-field-wrapper">
                                    <mat-form-field appearance="outline" class="shelf-gap-field">
                                        <mat-label>מידה {{param.default.length - idx}} - {{getUnitForParameter(param)}}</mat-label>
                                        <input matInput type="number" [min]="param.min" [max]="param.max" [step]="1"
                                            [(ngModel)]="param.default[param.default.length - 1 - idx]"
                                            (blur)="updateShelfParameterValue(param, param.default[param.default.length - 1 - idx], param.default.length - 1 - idx)"
                                            (keyup.enter)="updateShelfParameterValue(param, param.default[param.default.length - 1 - idx], param.default.length - 1 - idx)">
                                    </mat-form-field>
                                    <button *ngIf="idx !== param.default.length - 1" class="remove-shelf-btn"
                                        (click)="param.default.splice(param.default.length - 1 - idx,1); updateBeams()"
                                        [disabled]="param.default.length<=1" aria-label="הסר מדף">
                                        <svg width="14" height="14" viewBox="0 0 14 14">
                                            <circle cx="7" cy="7" r="6" fill="#fff" stroke="#d32f2f" stroke-width="1.2" />
                                            <line x1="4.5" y1="4.5" x2="9.5" y2="9.5" stroke="#d32f2f" stroke-width="1.5" />
                                            <line x1="9.5" y1="4.5" x2="4.5" y2="9.5" stroke="#d32f2f" stroke-width="1.5" />
                                        </svg>
                                    </button>
                </div>
            </div>
            
        </div>
    </div>
                    
                    <!-- טיפול בשולחן - פרמטר plata -->
                    <div *ngIf="isTable && param.name === 'plata'">
                        <label style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <div class="shelf-row">
                            <mat-form-field appearance="outline">
                                <mat-label>סוג קורה</mat-label>
                                <mat-select [(ngModel)]="param.selectedBeamIndex" (selectionChange)="updateBeams()">
                                    <mat-option *ngFor="let beam of param.beams; let bIdx = index" [value]="bIdx">
                                        {{beam.translatedName}}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                            <mat-form-field appearance="outline">
                                <mat-label>סוג עץ</mat-label>
                                <mat-select [(ngModel)]="param.selectedTypeIndex" (selectionChange)="updateBeams()">
                                    <mat-option *ngFor="let type of param.beams[param.selectedBeamIndex || 0]?.types || []; let tIdx = index" [value]="tIdx">
                                        {{type.translatedName}}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                    </div>
                    
                    <div *ngIf="param.type === 'beamSingle' && (!isTable || param.name !== 'plata')">
                        <label
                            style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <mat-form-field appearance="outline">
                            <mat-label>סוג קורה</mat-label>
                            <mat-select [(ngModel)]="param.selectedBeamIndex" (selectionChange)="updateBeams()">
                                <mat-option *ngFor="let beam of param.beams; let bIdx = index" [value]="bIdx">
                                    {{beam.translatedName}}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                        <mat-form-field appearance="outline">
                            <mat-label>סוג עץ</mat-label>
                            <mat-select [(ngModel)]="param.selectedTypeIndex" (selectionChange)="updateBeams()">
                                <mat-option
                                    *ngFor="let type of param.beams[param.selectedBeamIndex]?.types; let tIdx = index"
                                    [value]="tIdx">
                                    {{type.translatedName}}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
                    
                    <!-- פרמטר extraBeam מיוחד עבור שולחן -->
                    <div *ngIf="isTable && param.name === 'extraBeam'">
                        <label style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <div class="param-box non-beam">
                            <mat-form-field appearance="outline">
                                <mat-label>{{param.translatedName}} - {{getUnitForParameter(param)}}</mat-label>
                                <input matInput type="number" [min]="param.min" [max]="param.max"
                                    [step]="getStep(param.type)" [(ngModel)]="param.default" 
                                    (blur)="updateParameterValue(param, param.default)"
                                    (keyup.enter)="updateParameterValue(param, param.default)">
                            </mat-form-field>
                        </div>
                    </div>
                    
                    <div *ngIf="param.type !== 'beamSingle' && param.name !== 'shelfs' && (!isTable || param.name !== 'height') && param.name !== 'extraBeam'">
                        <label
                            style="font-weight:bold; display:block; margin-bottom: 1.5em;">{{param.translatedName}}</label>
                        <div class="param-box non-beam">
                            <mat-form-field appearance="outline">
                                <mat-label>{{param.translatedName}} - {{getUnitForParameter(param)}}</mat-label>
                                <input matInput type="number" [min]="param.min" [max]="param.max"
                                    [step]="getStep(param.type)" [(ngModel)]="param.default" 
                                    (blur)="updateParameterValue(param, param.default)"
                                    (keyup.enter)="updateParameterValue(param, param.default)">
                            </mat-form-field>
                        </div>
                    </div>
                </div>
                <!-- טבלת מידות המוצר -->
                <div class="product-dimensions-container">
                    <h3>מידות המוצר הסופי</h3>
                    <table class="dimensions-table">
                        <tr>
                            <td>אורך כולל:</td>
                            <td [innerHTML]="getProductDimensions().length"></td>
                        </tr>
                        <tr>
                            <td>רוחב כולל:</td>
                            <td [innerHTML]="getProductDimensions().width"></td>
                        </tr>
                        <tr>
                            <td>גובה כולל:</td>
                            <td [innerHTML]="getProductDimensions().height"></td>
                        </tr>
                        <tr>
                            <td>כמות קורות במדף:</td>
                            <td [innerHTML]="getProductDimensions().beamCount"></td>
                        </tr>
                        <tr>
                            <td>רווח בין קורות המדף:</td>
                            <td [innerHTML]="getProductDimensions().gapBetweenBeams"></td>
                        </tr>
                        <tr>
                            <td>כמות מדפים:</td>
                            <td [innerHTML]="getProductDimensions().shelfCount"></td>
                        </tr>
                        <tr>
                            <td>גבהי המדפים:</td>
                            <td [innerHTML]="getProductDimensions().shelfHeights"></td>
                        </tr>
                    </table>
                </div>
            </ng-container>
        </div>
        <div #rendererContainer class="renderer-container" [class.expanded]="!drawerOpen"></div>
    </div>
    
    <!-- אזור חישוב המחיר -->
    <div class="price-calculation-area">
        <button class="fullscreen-btn" mat-icon-button color="primary" 
                [matTooltip]="!isPriceManuOpen ? ('price-calculation.tooltip' | translate) : ''" 
                matTooltipPosition="left"
                (click)="togglePriceMenu()"
                aria-label="מסך מלא">
            <mat-icon>fullscreen</mat-icon>
        </button>
        <div class="price-info">
            <div class="price-display">
                <span class="price-label">מחיר:</span>
                <div class="price-loader" *ngIf="calculatedPrice === 0">
                    <mat-spinner diameter="20"></mat-spinner>
                    <div style="width: 5px;"></div>
                </div>
                <div class="price-value-inline" *ngIf="calculatedPrice > 0">
                    {{ calculatedPrice }} ₪
                </div>
            </div>
        </div>
        
        <!-- קופסא נוספת שמופיעה כשהתפריט פתוח -->
        <div class="price-menu-box" *ngIf="isPriceManuOpen">
            <!-- כותרת דינמית -->
            <span class="thinking-text" *ngIf="!BeamsDataForPricing || BeamsDataForPricing.length === 0">{{ 'price-calculation.first-title' | translate }}...</span>
            <span class="main-title" *ngIf="BeamsDataForPricing && BeamsDataForPricing.length > 0">חומרי גלם:</span>
            
            <!-- סיכום קורות -->
            <div class="materials-summary" *ngIf="BeamsDataForPricing && BeamsDataForPricing.length > 0">
                <div class="sub-title">קורות:</div>
                <div *ngFor="let beamData of BeamsDataForPricing" class="beam-type-section">
                    <!-- כותרת סוג הקורה -->
                    <div class="beam-name">{{ beamData.beamTranslatedName || beamData.beamName }} ({{ beamData.type.translatedName }})</div>
                    
                    <!-- רשימת המידות -->
                    <div *ngFor="let sizeData of beamData.totalSizes" class="size-item">
                        <span class="size-value">{{ sizeData.length }} ס"מ</span>
                        <span class="size-separator"></span>
                        <span class="size-count">{{ sizeData.count }} {{ 'price-calculation.units' | translate }}</span>
                    </div>
                </div>
            </div>
            
            <!-- סיכום ברגים -->
            <div class="materials-summary" *ngIf="ForgingDataForPricing && ForgingDataForPricing.length > 0">
                <div class="sub-title">ברגים:</div>
                <div class="beam-type-section">
                    <div *ngFor="let forgingData of ForgingDataForPricing" class="size-item">
                        <span class="size-value">{{ forgingData.length }} ס"מ</span>
                        <span class="size-separator"></span>
                        <span class="size-count">{{ forgingData.count }} {{ 'price-calculation.units' | translate }}</span>
                    </div>
                </div>
            </div>
            
            <!-- תוכנית חיתוך קורות -->
            <div class="materials-summary" *ngIf="cuttingPlan && cuttingPlan.length > 0">
                <div class="main-title">תוכנית חיתוך קורות:</div>
                <div class="beam-type-section">
                    <div *ngFor="let beam of cuttingPlan" class="beam-type-section">
                        <!-- כותרת קורה -->
                        <div class="beam-name">קורה #{{ beam.beamNumber }} - {{ beam.beamLength }} ס"מ ({{ beam.beamPrice }} ₪) - {{ beam.beamType }}</div>
                        
                        <!-- רשימת החתיכות מקובצות לפי גודל -->
                        <div *ngFor="let cutGroup of getCutGroups(beam.cuts)" class="size-item">
                            <span class="size-value">{{ cutGroup.length }} ס"מ</span>
                            <span class="size-separator"></span>
                            <span class="size-count">{{ cutGroup.count }} {{ 'price-calculation.units' | translate }}</span>
                        </div>
                    </div>
                </div>
            </div>